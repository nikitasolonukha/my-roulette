<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Колесо Фортуны</title>
  <style>
    :root{--bg1:#2c3e50;--bg2:#223043;--btn:#4c86ff;--btnText:#fff}
    *{box-sizing:border-box} html,body{height:100%}
    body{
      margin:0;color:#fff;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Arial;
      display:flex;align-items:center;justify-content:center;
      background:radial-gradient(1000px 600px at 50% 0%,#34495e 0%,var(--bg1) 50%,var(--bg2) 100%)
    }
    .container{text-align:center;padding:16px}
    h1{margin:0 0 18px;font-weight:800;letter-spacing:.2px}

    .wheel-wrap{position:relative;width:350px;margin:0 auto}
    canvas{display:block;width:350px;height:350px;margin:0 auto;background:transparent}

    /* единственная стрелка */
    #pointer{
      position:absolute;top:50%;right:-6px;transform:translateY(-50%);
      width:0;height:0;border-top:12px solid transparent;border-bottom:12px solid transparent;
      border-left:26px solid #ff3b30;filter:drop-shadow(0 2px 2px rgba(0,0,0,.4))
    }

    #spin-btn{
      margin-top:22px;padding:14px 28px;font-size:16px;font-weight:700;cursor:pointer;
      border:none;border-radius:12px;background:var(--btn);color:var(--btnText);
      box-shadow:0 10px 24px rgba(76,134,255,.35),inset 0 0 0 1px rgba(255,255,255,.12);
      transition:transform .08s ease,filter .2s ease
    }
    #spin-btn:hover{filter:brightness(1.06)}
    #spin-btn:active{transform:translateY(1px)}
    #spin-btn:disabled{background:#8a8a8a;cursor:not-allowed;box-shadow:none}
    .hint{opacity:.85;font-size:13px;margin:10px 0 0}

    /* модалка результата */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.55);
      display:flex;align-items:center;justify-content:center;padding:16px}
    .hidden{display:none}
    .modal-card{width:min(520px,92vw);background:#1e2736;border-radius:16px;padding:22px 20px;
      box-shadow:0 12px 30px rgba(0,0,0,.45);text-align:left}
    .modal-title{font-size:18px;font-weight:800;margin:0 0 10px}
    .modal-text{font-size:16px;line-height:1.6;color:#e9eef9;margin:0;white-space:pre-line;letter-spacing:.2px}
    .modal-text b{color:#fff}
    .modal-btn{margin-top:16px;padding:12px 18px;border:none;border-radius:10px;background:#36b37e;
      color:#fff;font-weight:700;cursor:pointer;box-shadow:0 6px 16px rgba(54,179,126,.35)}
    .meme{display:block;width:100%;max-height:360px;object-fit:contain;margin-top:14px;border-radius:10px}

    /* на десктопах — больше стартовый размер */
    @media (min-width:1024px){
      .wheel-wrap{width:440px}
      canvas{width:440px;height:440px}
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Испытай свою удачу!</h1>
    <div class="wheel-wrap">
      <canvas id="roulette" width="350" height="350"></canvas>
      <div id="pointer"></div>
    </div>
    <button id="spin-btn">Крутить!</button>
    <p id="hint" class="hint"></p>
  </div>

  <!-- модалка результата -->
  <div id="result-modal" class="modal hidden">
    <div class="modal-card">
      <div class="modal-title">Ваш приз</div>
      <div id="result-text" class="modal-text"></div>
      <img id="meme" class="meme hidden" alt="мем"/>
      <button id="close-modal" class="modal-btn">Понятно</button>
    </div>
  </div>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script>
    /* ===== НАСТРОЙКА ===== */
    // прод-вебхук n8n — поменяй на свой при необходимости
    var WEBHOOK_URL = 'https://solonflowai.ru/webhook/roulette_prize';

    // мемы для «дичь от логиста» (по желанию добавь ссылки)
    var LOGIST_MEMES = [
      // 'https://example.com/meme1.jpg',
      // 'https://example.com/meme2.png',
"https://github.com/nikitasolonukha/my-roulette/blob/main/%D0%BC%D0%B5%D0%BC%D1%8B%20%D1%80%D1%83%D0%BB%D0%B5%D1%82%D0%BA%D0%B0/1%20%D0%BC%D0%B5%D0%BC.PNG?raw=true",
"https://github.com/nikitasolonukha/my-roulette/blob/main/%D0%BC%D0%B5%D0%BC%D1%8B%20%D1%80%D1%83%D0%BB%D0%B5%D1%82%D0%BA%D0%B0/2%20%D0%BC%D0%B5%D0%BC.PNG?raw=true",
"https://github.com/nikitasolonukha/my-roulette/blob/main/%D0%BC%D0%B5%D0%BC%D1%8B%20%D1%80%D1%83%D0%BB%D0%B5%D1%82%D0%BA%D0%B0/3%20%D0%BC%D0%B5%D0%BC.PNG?raw=true",
"https://github.com/nikitasolonukha/my-roulette/blob/main/%D0%BC%D0%B5%D0%BC%D1%8B%20%D1%80%D1%83%D0%BB%D0%B5%D1%82%D0%BA%D0%B0/4%20%D0%BC%D0%B5%D0%BC.PNG?raw=true",
"https://github.com/nikitasolonukha/my-roulette/blob/main/%D0%BC%D0%B5%D0%BC%D1%8B%20%D1%80%D1%83%D0%BB%D0%B5%D1%82%D0%BA%D0%B0/5%20%D0%BC%D0%B5%D0%BC.PNG?raw=true"
    ];

    /* ===== Telegram SDK ===== */
    var tg = (window.Telegram && window.Telegram.WebApp) ? window.Telegram.WebApp : null;
    try{ tg && tg.ready && tg.ready(); }catch(_){}
    var user = (tg && tg.initDataUnsafe && tg.initDataUnsafe.user) ? tg.initDataUnsafe.user : null;
    var TG_ID = user ? user.id : null;
    var USERNAME = user ? user.username : null;

    /* ===== Версионированный флаг «крутил» + dev/reset ===== */
    var urlParams   = new URLSearchParams(location.search);
    var APP_VERSION = urlParams.get('v') || '1';
    var DEV_MODE    = urlParams.get('dev') === '1';
    var RESET_FLAG  = urlParams.get('reset') === '1';
    var STORAGE_KEY = 'roulette_played_v' + APP_VERSION;

    /* ===== DOM ===== */
    var canvas, ctx, spinBtn, hint, modal, resultText, memeImg, closeModal;

    /* ===== ДАННЫЕ СЕКТОРОВ ===== */
    var prizes = [
  { label: 'дичь от логиста',   color: '#1dd1a1', weight: 5 }, // мемы — чаще
  { label: 'сок благодарности', color: '#ff6b6b', weight: 3 }, // 100 ₽
  { label: 'быстрая полка',     color: '#feca57', weight: 2 }, // доставка
  { label: 'прямой перевод',    color: '#48dbfb', weight: 1 }  // 300 ₽ — реже всего
];
    var sectors = prizes.length;
    var arc = (2*Math.PI)/sectors;

    /* ===== ГЕОМЕТРИЯ/ОТРИСОВКА ===== */
    var spinning = false;
    var alreadyPlayed = false;
    var DPR = 1;
    var VISUAL_SIZE = 350; // CSS-пиксели

    function getEffectiveDPR(){
      var dv = (window.devicePixelRatio || 1);
      var vs = (window.visualViewport && window.visualViewport.scale) ? window.visualViewport.scale : 1;
      return Math.max(1, Math.round(dv * vs)); // целое => чётче
    }

    function resizeCanvas(){
      // динамический размер от ширины и высоты окна
      var w = Math.floor(window.innerWidth  * 0.92);
      var h = Math.floor(window.innerHeight * 0.55);
      var side = Math.min(480, Math.max(280, Math.min(w, h)));
      VISUAL_SIZE = side;

      canvas.style.width  = VISUAL_SIZE + 'px';
      canvas.style.height = VISUAL_SIZE + 'px';

      DPR = getEffectiveDPR();
      canvas.width  = VISUAL_SIZE * DPR;
      canvas.height = VISUAL_SIZE * DPR;

      ctx.setTransform(1,0,0,1,0,0);
      ctx.scale(DPR, DPR);
      ctx.imageSmoothingEnabled = true;

      drawStatic();
    }

    // Хелпер: авто-подгон шрифта + перенос до двух строк
    function fitLabelToSector(ctx, label, maxWidthPx, baseFontPx, minFontPx) {
      let fontPx = baseFontPx;
      while (fontPx >= minFontPx) {
        ctx.font = `600 ${fontPx}px -apple-system, Segoe UI, Roboto, Arial`;
        if (ctx.measureText(label).width <= maxWidthPx) {
          return { lines: [label], fontPx };
        }
        fontPx -= 1;
      }
      const words = label.split(' ');
      if (words.length === 1) return { lines: [label], fontPx: minFontPx };

      for (let cut = 1; cut < words.length; cut++) {
        const l1 = words.slice(0, cut).join(' ');
        const l2 = words.slice(cut).join(' ');
        let fp = baseFontPx;
        while (fp >= minFontPx) {
          ctx.font = `600 ${fp}px -apple-system, Segoe UI, Roboto, Arial`;
          if (Math.max(ctx.measureText(l1).width, ctx.measureText(l2).width) <= maxWidthPx) {
            return { lines: [l1, l2], fontPx: fp };
          }
          fp -= 1;
        }
      }
      return { lines: [label], fontPx: minFontPx };
    }

    function drawWheel(angle){
      var W = VISUAL_SIZE, H = VISUAL_SIZE;

      // «прищёлкнутые» координаты для чётких линий
      var cx = Math.floor(W/2) + 0.5;
      var cy = Math.floor(H/2) + 0.5;
      var r  = Math.floor(Math.min(cx, cy) - 8) + 0.5;

      ctx.save();
      ctx.translate(cx, cy);
      ctx.rotate(angle || 0);
      ctx.translate(-cx, -cy);

      for (var i=0;i<sectors;i++){
        var a0 = i*arc, a1 = a0 + arc;

        // сектор
        ctx.beginPath();
        ctx.moveTo(cx, cy);
        ctx.fillStyle = prizes[i].color;
        ctx.arc(cx, cy, r, a0, a1);
        ctx.closePath();
        ctx.fill();

        // граница сектора
        ctx.strokeStyle = 'rgba(0,0,0,.15)';
        ctx.lineWidth = 1;
        ctx.beginPath();
        ctx.arc(cx, cy, r, a0, a1);
        ctx.stroke();

        // подпись — крупная, читаемая, но не вылезает
        ctx.save();
        ctx.translate(cx, cy);
        ctx.rotate(a0 + arc/2);
        ctx.fillStyle = '#fff';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';

        // динамика от радиуса
        const baseFontPx = Math.round(Math.min(22, Math.max(13, r * 0.065)));
        const minFontPx  = Math.max(11, baseFontPx - 5);

        const maxTextWidth = r * 0.70; // безопасная ширина
        const tx           = r * 0.55; // чуть глубже внутрь сектора

        const fitted = fitLabelToSector(ctx, prizes[i].label, maxTextWidth, baseFontPx, minFontPx);
        ctx.font = `600 ${fitted.fontPx}px -apple-system, Segoe UI, Roboto, Arial`;

        // лёгкая тень: на мобилках слабее
        var isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
        ctx.shadowColor = isMobile ? 'rgba(0,0,0,.2)' : 'rgba(0,0,0,.28)';
        ctx.shadowBlur  = isMobile ? 0.6 : 1.1;

        if (fitted.lines.length === 1){
          ctx.fillText(fitted.lines[0], tx, 0);
        } else {
          const lh = fitted.fontPx + 2;
          ctx.fillText(fitted.lines[0], tx, -lh/2);
          ctx.fillText(fitted.lines[1], tx,  lh/2);
        }
        ctx.restore();
      }
      ctx.restore();

      // белый ободок
      ctx.lineWidth = 6;
      ctx.strokeStyle = 'rgba(255,255,255,.9)';
      ctx.beginPath(); ctx.arc(cx, cy, r+2, 0, Math.PI*2); ctx.stroke();

      // центр
      ctx.fillStyle = '#e5ecff';
      ctx.beginPath(); ctx.arc(cx, cy, 14, 0, Math.PI*2); ctx.fill();
      ctx.strokeStyle = 'rgba(0,0,0,.12)'; ctx.lineWidth = 1; ctx.stroke();
    }
    function drawStatic(){ ctx.clearRect(0,0,canvas.width,canvas.height); drawWheel(0); }

    /* ===== ТЕКСТЫ ===== */
    function buildMessageHTML(prizeLabel){
      if (prizeLabel === 'сок благодарности')
        return '🎉 <b>Поздравляем!</b> Вам выпал приз: 🧃 <b>Сок благодарности</b>\n\n💸 100 ₽ на карту.\n📩 Пришлите скрин вашему логисту — он всё организует.';
      if (prizeLabel === 'быстрая полка')
        return '🎉 <b>Поздравляем!</b> Вам выпал приз: 🚀 <b>Быстрая полка</b>\n\n📦 Приоритет на следующую доставку.\n📩 Пришлите скрин вашему логисту — он всё организует.';
      if (prizeLabel === 'прямой перевод')
        return '🎉 <b>Поздравляем!</b> Вам выпал приз: 💳 <b>Прямой перевод</b>\n\n💵 300 ₽ на карту.\n📩 Пришлите скрин вашему логисту — он всё организует.';
      if (prizeLabel === 'дичь от логиста')
        return '🎉 <b>Поздравляем!</b> Вам выпал приз: 😂 <b>Дичь от логиста</b>\n\nЛови мем! 😉';
      return '🎉 <b>Поздравляем!</b> Ваш приз: ' + prizeLabel;
    }
    function textForModal(prizeLabel){
      if (prizeLabel === 'сок благодарности')
        return 'Сок благодарности — 100 руб. на карту.\nПришлите скрин вашему логисту — он всё организует.';
      if (prizeLabel === 'быстрая полка')
        return 'Быстрая полка — приоритет на следующую доставку.\nПришлите скрин вашему логисту — он всё организует.';
      if (prizeLabel === 'прямой перевод')
        return 'Прямой перевод — 300 руб. на карту.\nПришлите скрин вашему логисту — он всё организует.';
      if (prizeLabel === 'дичь от логиста')
        return 'Дичь от логиста — лови мем 😄';
      return prizeLabel;
    }

    /* ===== ВЕБХУК ===== */
    function postPrize(payload){
      return fetch(WEBHOOK_URL, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        keepalive:true,
        body: JSON.stringify(payload)
      }).catch(()=>{});
    }

/* ===== СПИН (веса) ===== */
function pickIndexByWeight(arr) {
  const total = arr.reduce((s, x) => s + (x.weight || 1), 0);
  let r = Math.random() * total;
  for (let i = 0; i < arr.length; i++) {
    r -= (arr[i].weight || 1);
    if (r <= 0) return i;
  }
  return arr.length - 1;
}

function spin(){
  if (spinning) return;
  if (!DEV_MODE && alreadyPlayed) return; // «1 раз» (кроме dev)

  spinning = true; 
  spinBtn.disabled = true;

  // выбор сектора по весам + целевая остановка
  var chosenIdx = pickIndexByWeight(prizes);
  var stopAngle = chosenIdx * arc + arc/2;
  var total = (Math.random()*5 + 8)*2*Math.PI + stopAngle;
  var start = null, duration = 6000;

  function frame(ts){
    if(!start) start = ts;
    var p = Math.min(1, (ts - start)/duration);
    var ease = 1 - Math.pow(1 - p, 4);
    var angle = ease * total;

    ctx.clearRect(0, 0, canvas.width, canvas.height);
    drawWheel(angle);

    if (p < 1){
      requestAnimationFrame(frame);
    } else {
      var idx = chosenIdx;
      var prizeLabel = prizes[idx].label;

      var memeUrl = '';
      if (prizeLabel === 'дичь от логиста' && LOGIST_MEMES.length){
        memeUrl = LOGIST_MEMES[Math.floor(Math.random()*LOGIST_MEMES.length)];
      }

      var messageHTML = buildMessageHTML(prizeLabel, memeUrl);
      var modalText   = textForModal(prizeLabel);

      // модалка
      resultText.textContent = modalText;
      if (memeUrl){
        memeImg.src = memeUrl; 
        memeImg.classList.remove('hidden'); 
        memeImg.style.display = 'block';
      } else {
        memeImg.removeAttribute('src'); 
        memeImg.classList.add('hidden'); 
        memeImg.style.display = 'none';
      }
      modal.classList.remove('hidden');

      // локальный «1 раз»
      try{ if(!DEV_MODE) localStorage.setItem(STORAGE_KEY, '1'); }catch(_){}
      alreadyPlayed = !DEV_MODE;

      // отправка в n8n
      postPrize({
        tg_id: TG_ID,
        username: USERNAME,
        prize: prizeLabel,
        message_html: messageHTML,
        meme_url: memeUrl,
        ts: Date.now(),
        event_id: String(TG_ID||'0') + '-' + String(Date.now())
      });
    }
  }
  requestAnimationFrame(frame);
}

          // модалка
          resultText.textContent = modalText;
          if (memeUrl){
            memeImg.src = memeUrl; memeImg.classList.remove('hidden'); memeImg.style.display='block';
          } else {
            memeImg.removeAttribute('src'); memeImg.classList.add('hidden'); memeImg.style.display='none';
          }
          modal.classList.remove('hidden');

          // локальный «1 раз»
          try{ if(!DEV_MODE) localStorage.setItem(STORAGE_KEY,'1'); }catch(_){}
          alreadyPlayed = !DEV_MODE;

          // отправка в n8n
          postPrize({
            tg_id: TG_ID,
            username: USERNAME,
            prize: prizeLabel,
            message_html: messageHTML,
            meme_url: memeUrl,
            ts: Date.now(),
            event_id: String(TG_ID||'0') + '-' + String(Date.now())
          });
        }
      }
      requestAnimationFrame(frame);
    }

    /* ===== INIT ===== */
    function init(){
      // DOM
      canvas     = document.getElementById('roulette');
      ctx        = canvas.getContext('2d');
      spinBtn    = document.getElementById('spin-btn');
      hint       = document.getElementById('hint');
      modal      = document.getElementById('result-modal');
      resultText = document.getElementById('result-text');
      memeImg    = document.getElementById('meme');
      closeModal = document.getElementById('close-modal');

      // reset по параметру
      try{ if (RESET_FLAG) localStorage.removeItem(STORAGE_KEY); }catch(_){}

      // «1 раз» (кроме dev)
      try{
        if (!DEV_MODE && localStorage.getItem(STORAGE_KEY)==='1'){
          alreadyPlayed = true; spinBtn.disabled = true;
          hint.textContent = 'Вы уже крутили колесо на этом устройстве.';
        }
      }catch(_){}

      resizeCanvas();
      window.addEventListener('resize', resizeCanvas);
      spinBtn.addEventListener('click', spin);
      closeModal.addEventListener('click', function(){
        modal.classList.add('hidden');
        try{ tg && tg.close && tg.close(); }catch(_){}
      });
    }

    if (document.readyState === 'loading'){
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
  </script>
</body>
</html>




