<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>–ö–æ–ª–µ—Å–æ –§–æ—Ä—Ç—É–Ω—ã</title>
  <style>
    :root{--bg1:#2c3e50;--bg2:#223043;--btn:#4c86ff;--btnText:#fff}
    *{box-sizing:border-box;margin:0;padding:0}
    html{
      margin:0;
      padding:0;
      width:100%;
      height:100%;
      height:100vh;
      height:-webkit-fill-available;
      overflow:hidden;
      /* –§–æ–Ω –Ω–∞ html, —á—Ç–æ–±—ã –∑–∞–Ω–∏–º–∞–ª –≤–µ—Å—å —ç–∫—Ä–∞–Ω –≤–∫–ª—é—á–∞—è safe area */
      background:radial-gradient(1000px 600px at 50% 0%,#34495e 0%,var(--bg1) 50%,var(--bg2) 100%);
      background-color:var(--bg1);
      background-attachment:fixed;
      background-size:cover;
      background-repeat:no-repeat;
    }
    body{
      margin:0;
      padding:0;
      color:#fff;
      font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Arial;
      display:flex;
      align-items:center;
      justify-content:center;
      position:fixed;
      top:0;
      left:0;
      right:0;
      bottom:0;
      width:100vw;
      height:100vh;
      height:100%;
      min-height:100vh;
      min-height:-webkit-fill-available;
      overflow:hidden;
      /* –ï–¥–∏–Ω—ã–π —Ñ–æ–Ω –Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω, –≤–∫–ª—é—á–∞—è –æ–±–ª–∞—Å—Ç—å –∑–∞ —Å—Ç–∞—Ç—É—Å-–±–∞—Ä–æ–º –∏ Dynamic Island */
      background:radial-gradient(1000px 600px at 50% 0%,#34495e 0%,var(--bg1) 50%,var(--bg2) 100%);
      background-color:var(--bg1);
      background-attachment:fixed;
      background-size:cover;
      background-repeat:no-repeat;
      /* –ë–µ–∑ padding - —Ñ–æ–Ω –ø—Ä–æ—Ö–æ–¥–∏—Ç –∑–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω –≤–∫–ª—é—á–∞—è —Å—Ç–∞—Ç—É—Å-–±–∞—Ä */
    }
    .container{
      text-align:center;
      padding:0 16px 16px;
      width:100%;
      height:100%;
      display:flex;
      flex-direction:column;
      justify-content:center;
      align-items:center;
      /* –ö–æ–Ω—Ç–µ–Ω—Ç —Ü–µ–Ω—Ç—Ä–∏—Ä—É–µ—Ç—Å—è –≤ –¥–æ—Å—Ç—É–ø–Ω–æ–π –æ–±–ª–∞—Å—Ç–∏ –ø–æ–¥ header'–æ–º */
      padding-top:0;
    }
    h1{margin:0 0 18px;font-weight:800;letter-spacing:.2px}

    .wheel-wrap{position:relative;margin:0 auto;flex-shrink:0}
    canvas{display:block;margin:0 auto;background:transparent}

    /* –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–∞—è —Å—Ç—Ä–µ–ª–∫–∞ */
    #pointer{
      position:absolute;top:50%;right:-6px;transform:translateY(-50%);
      width:0;height:0;border-top:12px solid transparent;border-bottom:12px solid transparent;
      border-left:26px solid #ff3b30;filter:drop-shadow(0 2px 2px rgba(0,0,0,.4));
    }

    #spin-btn{
      margin-top:22px;padding:14px 28px;font-size:16px;font-weight:700;cursor:pointer;
      border:none;border-radius:12px;background:var(--btn);color:var(--btnText);
      box-shadow:0 10px 24px rgba(76,134,255,.35),inset 0 0 0 1px rgba(255,255,255,.12);
      transition:transform .08s ease,filter .2s ease
    }
    #spin-btn:hover{filter:brightness(1.06)}
    #spin-btn:active{transform:translateY(1px)}
    #spin-btn:disabled{background:#8a8a8a;cursor:not-allowed;box-shadow:none}
    .hint{opacity:.85;font-size:13px;margin:10px 0 0}

    /* –º–æ–¥–∞–ª–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.55);
      display:flex;align-items:center;justify-content:center;padding:16px}
    .hidden{display:none}
    .modal-card{width:min(520px,92vw);background:#1e2736;border-radius:16px;padding:22px 20px;
      box-shadow:0 12px 30px rgba(0,0,0,.45);text-align:left}
    .modal-title{font-size:18px;font-weight:800;margin:0 0 10px}
    .modal-text{font-size:16px;line-height:1.6;color:#e9eef9;margin:0;white-space:pre-line;letter-spacing:.2px}
    .modal-text b{color:#fff}
    .modal-btn{margin-top:16px;padding:12px 18px;border:none;border-radius:10px;background:#36b37e;
      color:#fff;font-weight:700;cursor:pointer;box-shadow:0 6px 16px rgba(54,179,126,.35)}
    .meme{display:block;width:100%;max-height:360px;object-fit:contain;margin-top:14px;border-radius:10px}

    /* Overlay –¥–ª—è —Ñ–æ–Ω–∞ –Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω */
    #fullscreen-bg{
      position:fixed !important;
      top:0 !important;
      left:0 !important;
      right:0 !important;
      bottom:0 !important;
      width:100vw !important;
      height:100vh !important;
      min-height:100vh !important;
      min-height:-webkit-fill-available !important;
      z-index:-999 !important;
      background:radial-gradient(1000px 600px at 50% 0%,#34495e 0%,var(--bg1) 50%,var(--bg2) 100%) !important;
      background-color:var(--bg1) !important;
      background-attachment:fixed !important;
      background-size:cover !important;
      background-repeat:no-repeat !important;
      margin:0 !important;
      padding:0 !important;
      pointer-events:none !important;
      overflow:hidden !important;
    }

    /* –Ω–∞ –¥–µ—Å–∫—Ç–æ–ø–∞—Ö ‚Äî –∫–æ–º–ø–∞–∫—Ç–Ω—ã–π —Ä–∞–∑–º–µ—Ä */
    @media (min-width:1024px){
      .container{
        width:auto;
        height:auto;
        max-width:440px;
        padding:24px;
      }
      .wheel-wrap{
        width:440px;
        max-width:440px;
      }
      canvas{
        width:440px;
        height:440px;
        max-width:440px;
      }
    }
  </style>
</head>
<body>
  <div id="fullscreen-bg"></div>
  <div class="container">
    <h1>–ò—Å–ø—ã—Ç–∞–π —Å–≤–æ—é —É–¥–∞—á—É!</h1>
    <div class="wheel-wrap">
      <canvas id="roulette" width="350" height="350"></canvas>
      <div id="pointer"></div>
    </div>
    <button id="spin-btn">–ö—Ä—É—Ç–∏—Ç—å!</button>
    <p id="hint" class="hint"></p>
  </div>

  <!-- –º–æ–¥–∞–ª–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ -->
  <div id="result-modal" class="modal hidden">
    <div class="modal-card">
      <div class="modal-title">–í–∞—à –ø—Ä–∏–∑</div>
      <div id="result-text" class="modal-text"></div>
      <img id="meme" class="meme hidden" alt="–º–µ–º"/>
      <button id="close-modal" class="modal-btn">–ü–æ–Ω—è—Ç–Ω–æ</button>
    </div>
  </div>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script>
    /* ===== –í–ê–ñ–ù–û: –ù–ê–°–¢–†–û–ô–ö–ê –î–õ–Ø –ü–û–õ–ù–û–≠–ö–†–ê–ù–ù–û–ì–û –†–ï–ñ–ò–ú–ê ===== */
    /* 
     * Direct Link —Å–æ–∑–¥–∞–Ω: t.me/ITL_otzivi_bot/itlotzivi
     * 
     * –î–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç—ã –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞ Mini Apps 2.0:
     * 1. –í –±–æ—Ç–µ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫—É —Ç–∏–ø–∞ web_app —Å Direct Link:
     *    KeyboardButton(text="–û—Ç–∫—Ä—ã—Ç—å –∫–æ–ª–µ—Å–æ", web_app=WebAppInfo(url="https://t.me/ITL_otzivi_bot/itlotzivi"))
     *    –ò–õ–ò –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø—Ä—è–º–æ–π URL –≤–∞—à–µ–≥–æ —Å–∞–π—Ç–∞:
     *    KeyboardButton(text="–û—Ç–∫—Ä—ã—Ç—å –∫–æ–ª–µ—Å–æ", web_app=WebAppInfo(url="https://–≤–∞—à-–¥–æ–º–µ–Ω.com"))
     * 2. –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –æ–±—ã—á–Ω—ã–µ URL-–∫–Ω–æ–ø–∫–∏ - —Ç–æ–ª—å–∫–æ web_app –∫–Ω–æ–ø–∫–∏
     * 3. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ –ø–æ—Å–ª–µ–¥–Ω—é—é –≤–µ—Ä—Å–∏—é Telegram
     * 4. –ü—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —á–µ—Ä–µ–∑ Direct Link –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –æ—Ç–∫—Ä—ã—Ç—å—Å—è –≤ –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω–æ–º —Ä–µ–∂–∏–º–µ
     */
    
    /* ===== –ù–ê–°–¢–†–û–ô–ö–ê ===== */
    // –ø—Ä–æ–¥-–≤–µ–±—Ö—É–∫ n8n ‚Äî –ø–æ–º–µ–Ω—è–π –Ω–∞ —Å–≤–æ–π –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
    var WEBHOOK_URL = 'https://solonflowai.ru/webhook/roulette_prize';

    // –º–µ–º—ã –¥–ª—è ¬´–¥–∏—á—å –æ—Ç –ª–æ–≥–∏—Å—Ç–∞¬ª
    var LOGIST_MEMES = [
      "https://raw.githubusercontent.com/nikitasolonukha/my-roulette/main/%D0%BC%D0%B5%D0%BC%D1%8B%20%D1%80%D1%83%D0%BB%D0%B5%D1%82%D0%BA%D0%B0/1%20%D0%BC%D0%B5%D0%BC.PNG",
      "https://raw.githubusercontent.com/nikitasolonukha/my-roulette/main/%D0%BC%D0%B5%D0%BC%D1%8B%20%D1%80%D1%83%D0%BB%D0%B5%D1%82%D0%BA%D0%B0/2%20%D0%BC%D0%B5%D0%BC.PNG",
      "https://raw.githubusercontent.com/nikitasolonukha/my-roulette/main/%D0%BC%D0%B5%D0%BC%D1%8B%20%D1%80%D1%83%D0%BB%D0%B5%D1%82%D0%BA%D0%B0/3%20%D0%BC%D0%B5%D0%BC.PNG",
      "https://raw.githubusercontent.com/nikitasolonukha/my-roulette/main/%D0%BC%D0%B5%D0%BC%D1%8B%20%D1%80%D1%83%D0%BB%D0%B5%D1%82%D0%BA%D0%B0/4%20%D0%BC%D0%B5%D0%BC.PNG",
      "https://raw.githubusercontent.com/nikitasolonukha/my-roulette/main/%D0%BC%D0%B5%D0%BC%D1%8B%20%D1%80%D1%83%D0%BB%D0%B5%D1%82%D0%BA%D0%B0/5%20%D0%BC%D0%B5%D0%BC.PNG"
    ];

    /* ===== Telegram SDK ===== */
    var tg = (window.Telegram && window.Telegram.WebApp) ? window.Telegram.WebApp : null;
    
    // –û—Ç–ª–∞–¥–∫–∞: –ø—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ Telegram WebApp
    if (tg) {
      console.log('‚úÖ Telegram WebApp –æ–±–Ω–∞—Ä—É–∂–µ–Ω');
      console.log('expand –¥–æ—Å—Ç—É–ø–µ–Ω:', typeof tg.expand === 'function');
    } else {
      console.warn('‚ö†Ô∏è Telegram WebApp –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω - –≤–æ–∑–º–æ–∂–Ω–æ, –æ—Ç–∫—Ä—ã—Ç–æ –Ω–µ –≤ Telegram');
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø–æ–ª–Ω–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞ —ç–∫—Ä–∞–Ω–∞
    function setFullScreenSize() {
      var bgOverlay = document.getElementById('fullscreen-bg');
      
      // –ò—Å–ø–æ–ª—å–∑—É–µ–º window.screen –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–µ–∞–ª—å–Ω–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞ —ç–∫—Ä–∞–Ω–∞
      var screenHeight = window.screen.height;
      var screenWidth = window.screen.width;
      
      // –¢–∞–∫–∂–µ –ø—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å —Ä–∞–∑–º–µ—Ä—ã –∏–∑ Telegram API
      var tgHeight = null;
      var tgWidth = null;
      if (tg) {
        tgHeight = tg.viewportStableHeight || tg.viewportHeight;
        tgWidth = tg.viewportWidth;
      }
      
      // –ò—Å–ø–æ–ª—å–∑—É–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–æ–∫—Ä—ã—Ç–∏—è
      var height = Math.max(
        screenHeight,
        tgHeight || 0,
        window.innerHeight || 0,
        document.documentElement.clientHeight || 0
      );
      
      var width = Math.max(
        screenWidth,
        tgWidth || 0,
        window.innerWidth || 0,
        document.documentElement.clientWidth || 0
      );
      
      // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä—ã –¥–ª—è html –∏ body
      document.documentElement.style.height = height + 'px';
      document.documentElement.style.minHeight = height + 'px';
      document.body.style.height = height + 'px';
      document.body.style.minHeight = height + 'px';
      
      // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä—ã –¥–ª—è overlay —Ñ–æ–Ω–∞ –Ω–∞–ø—Ä—è–º—É—é —á–µ—Ä–µ–∑ style
      if (bgOverlay) {
        bgOverlay.style.setProperty('height', height + 'px', 'important');
        bgOverlay.style.setProperty('width', width + 'px', 'important');
        bgOverlay.style.setProperty('min-height', height + 'px', 'important');
        bgOverlay.style.setProperty('top', '0', 'important');
        bgOverlay.style.setProperty('left', '0', 'important');
        bgOverlay.style.setProperty('right', '0', 'important');
        bgOverlay.style.setProperty('bottom', '0', 'important');
      }
    }
    
  try{ 
    if (tg) {
      // –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û –¥–ª—è –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞:
      // 1. expand() –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –î–û ready()
      // 2. –¶–≤–µ—Ç–∞ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—Ç—Å—è –î–û expand()
      // 3. ready() –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –ü–û–°–õ–ï expand()
      
      // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ü–≤–µ—Ç–∞ —Ñ–æ–Ω–∞ –ü–ï–†–í–´–ú –¥–µ–ª–æ–º
      try {
        tg.setHeaderColor && tg.setHeaderColor('#2c3e50');
        tg.setBackgroundColor && tg.setBackgroundColor('#2c3e50');
      } catch(e) {
        console.warn('–û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Ü–≤–µ—Ç–æ–≤:', e);
      }
      
      // –ö–†–ò–¢–ò–ß–ù–û: expand() –î–û ready() - —ç—Ç–æ –∫–ª—é—á –∫ –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω–æ–º—É —Ä–µ–∂–∏–º—É
      if (tg.expand) {
        try { 
          console.log('üöÄ –í—ã–∑—ã–≤–∞—é tg.expand() –î–û ready()');
          tg.expand(); 
          console.log('‚úÖ tg.expand() –≤—ã–∑–≤–∞–Ω —É—Å–ø–µ—à–Ω–æ');
        } catch(e) { 
          console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–∑–æ–≤–µ expand:', e); 
        }
      }
      
      // –¢–µ–ø–µ—Ä—å –≤—ã–∑—ã–≤–∞–µ–º ready()
      try {
        tg.ready && tg.ready();
      } catch(e) {
        console.warn('–û—à–∏–±–∫–∞ ready():', e);
      }
      
      // –í–∫–ª—é—á–∞–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–∏—è (–æ—Ç–∫–ª—é—á–∞–µ—Ç swipe to dismiss)
      try {
        tg.enableClosingConfirmation && tg.enableClosingConfirmation();
      } catch(e) {
        console.warn('–û—à–∏–±–∫–∞ enableClosingConfirmation:', e);
      }
      
      // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –≤—ã–∑–æ–≤—ã expand() –ø–æ—Å–ª–µ ready() –¥–ª—è –≥–∞—Ä–∞–Ω—Ç–∏–∏
      if (tg.expand) {
        setTimeout(function(){ 
          try { 
            tg.expand(); 
            console.log('‚úÖ tg.expand() –≤—ã–∑–≤–∞–Ω –ø–æ—Å–ª–µ ready (50ms)');
          } catch(e) {} 
        }, 50);
        setTimeout(function(){ 
          try { 
            tg.expand(); 
            console.log('‚úÖ tg.expand() –≤—ã–∑–≤–∞–Ω –ø–æ—Å–ª–µ ready (100ms)');
          } catch(e) {} 
        }, 100);
        setTimeout(function(){ 
          try { 
            tg.expand(); 
          } catch(e) {} 
        }, 200);
        setTimeout(function(){ 
          try { 
            tg.expand(); 
          } catch(e) {} 
        }, 500);
      }
      
      // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä—ã –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ –ø–æ–∫—Ä—ã—Ç–∏—è —ç–∫—Ä–∞–Ω–∞
      setFullScreenSize();
      setTimeout(setFullScreenSize, 50);
      setTimeout(setFullScreenSize, 100);
      setTimeout(setFullScreenSize, 200);
      setTimeout(setFullScreenSize, 300);
      setTimeout(setFullScreenSize, 500);
      
      // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è viewport (–≤–∞–∂–Ω–æ –¥–ª—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞)
      if (tg.onEvent) {
        tg.onEvent('viewportChanged', function(){
          console.log('üîÑ viewportChanged —Å–æ–±—ã—Ç–∏–µ');
          setTimeout(function(){
            if (tg.expand) {
              try {
                tg.expand();
                console.log('‚úÖ expand() –ø–æ—Å–ª–µ viewportChanged');
              } catch(e) {}
            }
            setFullScreenSize();
          }, 50);
        });
      }
      
      // –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ—Å–ª–µ –ø–æ–ª–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
      window.addEventListener('load', function(){
        setTimeout(function(){
          if (tg.expand) {
            try {
              tg.expand();
              console.log('‚úÖ expand() –ø–æ—Å–ª–µ window.load');
            } catch(e) {}
          }
          setFullScreenSize();
        }, 100);
        setTimeout(function(){
          if (tg.expand) {
            try {
              tg.expand();
            } catch(e) {}
          }
          setFullScreenSize();
        }, 300);
      });
      
      // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–±—ã—Ç–∏—è ready (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–æ)
      if (tg.onEvent) {
        tg.onEvent('ready', function(){
          console.log('‚úÖ Telegram WebApp ready');
          setTimeout(function(){
            if (tg.expand) {
              try {
                tg.expand();
                console.log('‚úÖ expand() –ø–æ—Å–ª–µ ready —Å–æ–±—ã—Ç–∏–µ');
              } catch(e) {}
            }
            setFullScreenSize();
          }, 50);
        });
      }
    } else {
      // –ï—Å–ª–∏ –Ω–µ –≤ Telegram, –≤—Å–µ —Ä–∞–≤–Ω–æ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä—ã
      setFullScreenSize();
    }
  }catch(e){
    // Fallback –µ—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫
    console.error('Telegram WebApp error:', e);
    setFullScreenSize();
  }
  var user = (tg && tg.initDataUnsafe && tg.initDataUnsafe.user) ? tg.initDataUnsafe.user : null;
  var TG_ID = user ? user.id : null;
  var USERNAME = user ? user.username : null;

    /* ===== –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ñ–ª–∞–≥ ¬´–∫—Ä—É—Ç–∏–ª¬ª + dev/reset ===== */
    var urlParams   = new URLSearchParams(location.search);
    var APP_VERSION = urlParams.get('v') || '1';
    var DEV_MODE    = urlParams.get('dev') === '1';
    var RESET_FLAG  = urlParams.get('reset') === '1';
    var STORAGE_KEY = 'roulette_played_v' + APP_VERSION;

    /* ===== DOM ===== */
    var canvas, ctx, spinBtn, hint, modal, resultText, memeImg, closeModal;

    /* ===== –î–ê–ù–ù–´–ï –°–ï–ö–¢–û–†–û–í ===== */
    var prizes = [
      { label: '–¥–∏—á—å –æ—Ç –ª–æ–≥–∏—Å—Ç–∞',            color: '#1dd1a1', weight: 45.45 }, // –º–µ–º—ã ‚Äî —á–∞—â–µ –≤—Å–µ–≥–æ
      { label: '—Å–æ–∫ –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç–∏',          color: '#ff6b6b', weight: 27.27 }, // 100 ‚ÇΩ
      { label: '–±—ã—Å—Ç—Ä–∞—è –ø–æ–ª–∫–∞',              color: '#feca57', weight: 18.18 }, // –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –Ω–∞ –¥–æ—Å—Ç–∞–≤–∫—É
      { label: '–ø—Ä—è–º–æ–π –ø–µ—Ä–µ–≤–æ–¥',             color: '#48dbfb', weight: 5 },     // 300 ‚ÇΩ
      { label: '—Å–∫–∏–¥–∫–∞ –Ω–∞ –¥–æ—Å—Ç–∞–≤–∫—É -10%',    color: '#9b59b6', weight: 10 },    // —Å–∫–∏–¥–∫–∞ –Ω–∞ —Å–ª–µ–¥—É—é—â—É—é –¥–æ—Å—Ç–∞–≤–∫—É
      { label: '—Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç Ozon',            color: '#6366f1', weight: 1 },     // –º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å
      { label: '—Å—Ç—Ä–∞—Ö–æ–≤–∫–∞ –Ω–∞ –æ—Ç–ø—Ä–∞–≤–∫—É',      color: '#2ecc71', weight: 30 },    // –±–µ—Å–ø–ª–∞—Ç–Ω–∞—è —Å—Ç—Ä–∞—Ö–æ–≤–∫–∞
      { label: '–≤—Ç–æ—Ä–æ–π —à–∞–Ω—Å',                color: '#ff9f43', weight: 10 }     // –µ—â—ë –æ–¥–Ω–∞ –ø–æ–ø—ã—Ç–∫–∞
    ];
    var sectors = prizes.length;
    var arc = (2*Math.PI)/sectors;

    /* ===== –ì–ï–û–ú–ï–¢–†–ò–Ø/–û–¢–†–ò–°–û–í–ö–ê ===== */
    var spinning = false;
    var alreadyPlayed = false;
    var secondChanceAvailable = false;
    var secondChanceConsumed = false;
    var usingSecondChanceNow = false;
    var DPR = 1;
    var VISUAL_SIZE = 350; // CSS-–ø–∏–∫—Å–µ–ª–∏

    function getEffectiveDPR(){
      var dv = (window.devicePixelRatio || 1);
      var vs = (window.visualViewport && window.visualViewport.scale) ? window.visualViewport.scale : 1;
      return Math.max(1, Math.round(dv * vs)); // —Ü–µ–ª–æ–µ => —á—ë—Ç—á–µ
    }

    function resizeCanvas(){
      // –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö ‚Äî –ø–æ—á—Ç–∏ –≤–µ—Å—å —ç–∫—Ä–∞–Ω, –Ω–∞ –¥–µ—Å–∫—Ç–æ–ø–∞—Ö ‚Äî –∫–æ–º–ø–∞–∫—Ç–Ω–æ
      var isMobile = window.innerWidth < 1024;
      var w, h, side;
      
      if (isMobile) {
        // –º–æ–±–∏–ª—å–Ω—ã–µ: –∏—Å–ø–æ–ª—å–∑—É–µ–º 90% –æ—Ç –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–π —Å—Ç–æ—Ä–æ–Ω—ã —ç–∫—Ä–∞–Ω–∞
        w = Math.floor(window.innerWidth  * 0.90);
        h = Math.floor(window.innerHeight * 0.75); // –±–æ–ª—å—à–µ –º–µ—Å—Ç–∞ –¥–ª—è –∫–æ–ª–µ—Å–∞
        side = Math.min(w, h);
      } else {
        // –¥–µ—Å–∫—Ç–æ–ø: —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ä–∞–∑–º–µ—Ä
        side = 440;
      }
      
      VISUAL_SIZE = side;

      var wheelWrap = document.querySelector('.wheel-wrap');
      if (wheelWrap) {
        wheelWrap.style.width = VISUAL_SIZE + 'px';
        wheelWrap.style.height = VISUAL_SIZE + 'px';
      }

      canvas.style.width  = VISUAL_SIZE + 'px';
      canvas.style.height = VISUAL_SIZE + 'px';

      DPR = getEffectiveDPR();
      canvas.width  = VISUAL_SIZE * DPR;
      canvas.height = VISUAL_SIZE * DPR;

      ctx.setTransform(1,0,0,1,0,0);
      ctx.scale(DPR, DPR);
      ctx.imageSmoothingEnabled = true;

      drawStatic();
    }

    // –•–µ–ª–ø–µ—Ä: –∞–≤—Ç–æ-–ø–æ–¥–≥–æ–Ω —à—Ä–∏—Ñ—Ç–∞ + –ø–µ—Ä–µ–Ω–æ—Å –¥–æ –¥–≤—É—Ö —Å—Ç—Ä–æ–∫
    function fitLabelToSector(ctx, label, maxWidthPx, baseFontPx, minFontPx) {
      let fontPx = baseFontPx;
      while (fontPx >= minFontPx) {
        ctx.font = `600 ${fontPx}px -apple-system, Segoe UI, Roboto, Arial`;
        if (ctx.measureText(label).width <= maxWidthPx) {
          return { lines: [label], fontPx };
        }
        fontPx -= 1;
      }
      const words = label.split(' ');
      if (words.length === 1) return { lines: [label], fontPx: minFontPx };

      for (let cut = 1; cut < words.length; cut++) {
        const l1 = words.slice(0, cut).join(' ');
        const l2 = words.slice(cut).join(' ');
        let fp = baseFontPx;
        while (fp >= minFontPx) {
          ctx.font = `600 ${fp}px -apple-system, Segoe UI, Roboto, Arial`;
          if (Math.max(ctx.measureText(l1).width, ctx.measureText(l2).width) <= maxWidthPx) {
            return { lines: [l1, l2], fontPx: fp };
          }
          fp -= 1;
        }
      }
      return { lines: [label], fontPx: minFontPx };
    }

    function drawWheel(angle){
      var W = VISUAL_SIZE, H = VISUAL_SIZE;

      // ¬´–ø—Ä–∏—â—ë–ª–∫–Ω—É—Ç—ã–µ¬ª –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –¥–ª—è —á—ë—Ç–∫–∏—Ö –ª–∏–Ω–∏–π
      var cx = Math.floor(W/2) + 0.5;
      var cy = Math.floor(H/2) + 0.5;
      var r  = Math.floor(Math.min(cx, cy) - 8) + 0.5;

      ctx.save();
      ctx.translate(cx, cy);
      ctx.rotate(angle || 0);
      ctx.translate(-cx, -cy);

      for (var i=0;i<sectors;i++){
        var a0 = i*arc, a1 = a0 + arc;

        // —Å–µ–∫—Ç–æ—Ä
        ctx.beginPath();
        ctx.moveTo(cx, cy);
        ctx.fillStyle = prizes[i].color;
        ctx.arc(cx, cy, r, a0, a1);
        ctx.closePath();
        ctx.fill();

        // –≥—Ä–∞–Ω–∏—Ü–∞ —Å–µ–∫—Ç–æ—Ä–∞
        ctx.strokeStyle = 'rgba(0,0,0,.15)';
        ctx.lineWidth = 1;
        ctx.beginPath();
        ctx.arc(cx, cy, r, a0, a1);
        ctx.stroke();

        // –ø–æ–¥–ø–∏—Å—å ‚Äî –∫—Ä—É–ø–Ω–∞—è, —á–∏—Ç–∞–µ–º–∞—è, –Ω–æ –Ω–µ –≤—ã–ª–µ–∑–∞–µ—Ç
        ctx.save();
        ctx.translate(cx, cy);
        ctx.rotate(a0 + arc/2);
        ctx.fillStyle = '#fff';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';

        // –¥–∏–Ω–∞–º–∏–∫–∞ –æ—Ç —Ä–∞–¥–∏—É—Å–∞
        const baseFontPx = Math.round(Math.min(22, Math.max(13, r * 0.065)));
        const minFontPx  = Math.max(11, baseFontPx - 5);

        const maxTextWidth = r * 0.70; // –±–µ–∑–æ–ø–∞—Å–Ω–∞—è —à–∏—Ä–∏–Ω–∞
        const tx           = r * 0.55; // —á—É—Ç—å –≥–ª—É–±–∂–µ –≤–Ω—É—Ç—Ä—å —Å–µ–∫—Ç–æ—Ä–∞

        const fitted = fitLabelToSector(ctx, prizes[i].label, maxTextWidth, baseFontPx, minFontPx);
        ctx.font = `600 ${fitted.fontPx}px -apple-system, Segoe UI, Roboto, Arial`;

        // –ª—ë–≥–∫–∞—è —Ç–µ–Ω—å: –Ω–∞ –º–æ–±–∏–ª–∫–∞—Ö —Å–ª–∞–±–µ–µ
        var isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
        ctx.shadowColor = isMobile ? 'rgba(0,0,0,.2)' : 'rgba(0,0,0,.28)';
        ctx.shadowBlur  = isMobile ? 0.6 : 1.1;

        if (fitted.lines.length === 1){
          ctx.fillText(fitted.lines[0], tx, 0);
        } else {
          const lh = fitted.fontPx + 2;
          ctx.fillText(fitted.lines[0], tx, -lh/2);
          ctx.fillText(fitted.lines[1], tx,  lh/2);
        }
        ctx.restore();
      }
      ctx.restore();

      // –±–µ–ª—ã–π –æ–±–æ–¥–æ–∫
      ctx.lineWidth = 6;
      ctx.strokeStyle = 'rgba(255,255,255,.9)';
      ctx.beginPath(); ctx.arc(cx, cy, r+2, 0, Math.PI*2); ctx.stroke();

      // —Ü–µ–Ω—Ç—Ä
      ctx.fillStyle = '#e5ecff';
      ctx.beginPath(); ctx.arc(cx, cy, 14, 0, Math.PI*2); ctx.fill();
      ctx.strokeStyle = 'rgba(0,0,0,.12)'; ctx.lineWidth = 1; ctx.stroke();
    }
    function drawStatic(){ ctx.clearRect(0,0,canvas.width,canvas.height); drawWheel(0); }

    /* ===== –¢–ï–ö–°–¢–´ ===== */
    function buildMessageHTML(prizeLabel){
      if (prizeLabel === '—Å–æ–∫ –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç–∏')
        return 'üéâ <b>–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º!</b> –í–∞–º –≤—ã–ø–∞–ª –ø—Ä–∏–∑: üßÉ <b>–°–æ–∫ –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç–∏</b>\n\nüí∏ 100 ‚ÇΩ –Ω–∞ –∫–∞—Ä—Ç—É.\nüì© –ü—Ä–∏—à–ª–∏—Ç–µ —Å–∫—Ä–∏–Ω –≤–∞—à–µ–º—É –ª–æ–≥–∏—Å—Ç—É ‚Äî –æ–Ω –≤—Å—ë –æ—Ä–≥–∞–Ω–∏–∑—É–µ—Ç.';
      if (prizeLabel === '–±—ã—Å—Ç—Ä–∞—è –ø–æ–ª–∫–∞')
        return 'üéâ <b>–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º!</b> –í–∞–º –≤—ã–ø–∞–ª –ø—Ä–∏–∑: üöÄ <b>–ë—ã—Å—Ç—Ä–∞—è –ø–æ–ª–∫–∞</b>\n\nüì¶ –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –Ω–∞ —Å–ª–µ–¥—É—é—â—É—é –¥–æ—Å—Ç–∞–≤–∫—É.\nüì© –ü—Ä–∏—à–ª–∏—Ç–µ —Å–∫—Ä–∏–Ω –≤–∞—à–µ–º—É –ª–æ–≥–∏—Å—Ç—É ‚Äî –æ–Ω –≤—Å—ë –æ—Ä–≥–∞–Ω–∏–∑—É–µ—Ç.';
      if (prizeLabel === '–ø—Ä—è–º–æ–π –ø–µ—Ä–µ–≤–æ–¥')
        return 'üéâ <b>–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º!</b> –í–∞–º –≤—ã–ø–∞–ª –ø—Ä–∏–∑: üí≥ <b>–ü—Ä—è–º–æ–π –ø–µ—Ä–µ–≤–æ–¥</b>\n\nüíµ 300 ‚ÇΩ –Ω–∞ –∫–∞—Ä—Ç—É.\nüì© –ü—Ä–∏—à–ª–∏—Ç–µ —Å–∫—Ä–∏–Ω –≤–∞—à–µ–º—É –ª–æ–≥–∏—Å—Ç—É ‚Äî –æ–Ω –≤—Å—ë –æ—Ä–≥–∞–Ω–∏–∑—É–µ—Ç.';
      if (prizeLabel === '—Å–∫–∏–¥–∫–∞ –Ω–∞ –¥–æ—Å—Ç–∞–≤–∫—É -10%')
        return 'üéâ <b>–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º!</b> –í–∞–º –≤—ã–ø–∞–ª –ø—Ä–∏–∑: üìâ <b>–°–∫–∏–¥–∫–∞ –Ω–∞ —Å–ª–µ–¥—É—é—â—É—é –¥–æ—Å—Ç–∞–≤–∫—É</b>\n\nüîü -10% –Ω–∞ –±–ª–∏–∂–∞–π—à—É—é –¥–æ—Å—Ç–∞–≤–∫—É.\nüì© –ü—Ä–∏—à–ª–∏—Ç–µ —Å–∫—Ä–∏–Ω –≤–∞—à–µ–º—É –ª–æ–≥–∏—Å—Ç—É ‚Äî –æ–Ω –ø—Ä–∏–º–µ–Ω–∏—Ç —Å–∫–∏–¥–∫—É.';
      if (prizeLabel === '—Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç Ozon')
        return 'üéâ <b>–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º!</b> –í–∞–º –≤—ã–ø–∞–ª –ø—Ä–∏–∑: üõçÔ∏è <b>–ü–æ–¥–∞—Ä–æ—á–Ω—ã–π —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç Ozon</b>\n\nüéÅ –õ–æ–≥–∏—Å—Ç –æ—Ç–ø—Ä–∞–≤–∏—Ç –ø—Ä–æ–º–æ–∫–æ–¥ –ø–æ—Å–ª–µ —Å–≤–µ—Ä–∫–∏.';
      if (prizeLabel === '—Å—Ç—Ä–∞—Ö–æ–≤–∫–∞ –Ω–∞ –æ—Ç–ø—Ä–∞–≤–∫—É')
        return 'üéâ <b>–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º!</b> –í–∞–º –≤—ã–ø–∞–ª –ø—Ä–∏–∑: üõ°Ô∏è <b>–ë–µ—Å–ø–ª–∞—Ç–Ω–∞—è —Å—Ç—Ä–∞—Ö–æ–≤–∫–∞</b>\n\nüì¶ –ó–∞—â–∏—Ç–∏–º –æ–¥–Ω—É –æ—Ç–ø—Ä–∞–≤–∫—É –∑–∞ –Ω–∞—à —Å—á—ë—Ç.\nüì© –ü—Ä–∏—à–ª–∏—Ç–µ —Å–∫—Ä–∏–Ω –≤–∞—à–µ–º—É –ª–æ–≥–∏—Å—Ç—É ‚Äî –æ–Ω –≤—Å—ë –æ—Ñ–æ—Ä–º–∏—Ç.';
      if (prizeLabel === '–≤—Ç–æ—Ä–æ–π —à–∞–Ω—Å')
        return '‚ú® <b>–í—Ç–æ—Ä–æ–π —à–∞–Ω—Å!</b>\n\n–ö—Ä—É—Ç–∏—Ç–µ –∫–æ–ª–µ—Å–æ –µ—â—ë —Ä–∞–∑.';
      if (prizeLabel === '–¥–∏—á—å –æ—Ç –ª–æ–≥–∏—Å—Ç–∞')
        return 'üéâ <b>–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º!</b> –í–∞–º –≤—ã–ø–∞–ª –ø—Ä–∏–∑: üòÇ <b>–î–∏—á—å –æ—Ç –ª–æ–≥–∏—Å—Ç–∞</b>\n\n–õ–æ–≤–∏ –º–µ–º! üòâ';
      return 'üéâ <b>–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º!</b> –í–∞—à –ø—Ä–∏–∑: ' + prizeLabel;
    }
    function textForModal(prizeLabel){
      if (prizeLabel === '—Å–æ–∫ –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç–∏')
        return '–°–æ–∫ –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç–∏ ‚Äî 100 —Ä—É–±. –Ω–∞ –∫–∞—Ä—Ç—É.\n–ü—Ä–∏—à–ª–∏—Ç–µ —Å–∫—Ä–∏–Ω –≤–∞—à–µ–º—É –ª–æ–≥–∏—Å—Ç—É ‚Äî –æ–Ω –≤—Å—ë –æ—Ä–≥–∞–Ω–∏–∑—É–µ—Ç.';
      if (prizeLabel === '–±—ã—Å—Ç—Ä–∞—è –ø–æ–ª–∫–∞')
        return '–ë—ã—Å—Ç—Ä–∞—è –ø–æ–ª–∫–∞ ‚Äî –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –Ω–∞ —Å–ª–µ–¥—É—é—â—É—é –¥–æ—Å—Ç–∞–≤–∫—É.\n–ü—Ä–∏—à–ª–∏—Ç–µ —Å–∫—Ä–∏–Ω –≤–∞—à–µ–º—É –ª–æ–≥–∏—Å—Ç—É ‚Äî –æ–Ω –≤—Å—ë –æ—Ä–≥–∞–Ω–∏–∑—É–µ—Ç.';
      if (prizeLabel === '–ø—Ä—è–º–æ–π –ø–µ—Ä–µ–≤–æ–¥')
        return '–ü—Ä—è–º–æ–π –ø–µ—Ä–µ–≤–æ–¥ ‚Äî 300 —Ä—É–±. –Ω–∞ –∫–∞—Ä—Ç—É.\n–ü—Ä–∏—à–ª–∏—Ç–µ —Å–∫—Ä–∏–Ω –≤–∞—à–µ–º—É –ª–æ–≥–∏—Å—Ç—É ‚Äî –æ–Ω –≤—Å—ë –æ—Ä–≥–∞–Ω–∏–∑—É–µ—Ç.';
      if (prizeLabel === '–¥–∏—á—å –æ—Ç –ª–æ–≥–∏—Å—Ç–∞')
        return '–î–∏—á—å –æ—Ç –ª–æ–≥–∏—Å—Ç–∞ ‚Äî –ª–æ–≤–∏ –º–µ–º üòÑ';
      if (prizeLabel === '—Å–∫–∏–¥–∫–∞ –Ω–∞ –¥–æ—Å—Ç–∞–≤–∫—É -10%')
        return '–°–∫–∏–¥–∫–∞ -10% –Ω–∞ —Å–ª–µ–¥—É—é—â—É—é –¥–æ—Å—Ç–∞–≤–∫—É.\n–°–≤—è–∂–∏—Ç–µ—Å—å —Å –ª–æ–≥–∏—Å—Ç–æ–º –∏ –ø–æ–∫–∞–∂–∏—Ç–µ —Å–∫—Ä–∏–Ω.';
      if (prizeLabel === '—Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç Ozon')
        return '–ü–æ–¥–∞—Ä–æ—á–Ω—ã–π —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç Ozon.\n–õ–æ–≥–∏—Å—Ç –ø—Ä–∏—à–ª—ë—Ç –ø—Ä–æ–º–æ–∫–æ–¥ –ø–æ—Å–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è.';
      if (prizeLabel === '—Å—Ç—Ä–∞—Ö–æ–≤–∫–∞ –Ω–∞ –æ—Ç–ø—Ä–∞–≤–∫—É')
        return '–ë–µ—Å–ø–ª–∞—Ç–Ω–∞—è —Å—Ç—Ä–∞—Ö–æ–≤–∫–∞ –¥–ª—è –æ–¥–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏.\n–õ–æ–≥–∏—Å—Ç –æ—Ñ–æ—Ä–º–∏—Ç –≤—Å—ë –ø–æ —Å–∫—Ä–∏–Ω—É.';
      if (prizeLabel === '–≤—Ç–æ—Ä–æ–π —à–∞–Ω—Å')
        return '–í–∞–º –≤—ã–ø–∞–ª –≤—Ç–æ—Ä–æ–π —à–∞–Ω—Å! –ó–∞–∫—Ä–æ–π—Ç–µ –æ–∫–Ω–æ –∏ –∫—Ä—É—Ç–∏—Ç–µ –∫–æ–ª–µ—Å–æ –µ—â—ë —Ä–∞–∑.';
      return prizeLabel;
    }

    /* ===== –í–ï–ë–•–£–ö ===== */
    function postPrize(payload){
      return fetch(WEBHOOK_URL, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        keepalive:true,
        body: JSON.stringify(payload)
      }).catch(()=>{});
    }

/* ===== –°–ü–ò–ù (–≤–µ—Å–∞) ===== */
function pickIndexByWeight(arr) {
  const total = arr.reduce((s, x) => s + (x.weight || 1), 0);
  let r = Math.random() * total;
  for (let i = 0; i < arr.length; i++) {
    r -= (arr[i].weight || 1);
    if (r <= 0) return i;
  }
  return arr.length - 1;
}

function spin(){
  if (spinning) return;
  if (!DEV_MODE && alreadyPlayed && !secondChanceAvailable) return; // ¬´1 —Ä–∞–∑¬ª (–∫—Ä–æ–º–µ dev), –∫—Ä–æ–º–µ –≤—Ç–æ—Ä–æ–≥–æ —à–∞–Ω—Å–∞

  usingSecondChanceNow = false;
  if (hint) hint.textContent = '';

  if (secondChanceAvailable){
    usingSecondChanceNow = true;
    secondChanceAvailable = false;
    secondChanceConsumed = true;
    try{ if(!DEV_MODE) localStorage.setItem(STORAGE_KEY, '1'); }catch(_){}
  }

  spinning = true; 
  spinBtn.disabled = true;

  // –≤—ã–±–æ—Ä —Å–µ–∫—Ç–æ—Ä–∞ –ø–æ –≤–µ—Å–∞–º + —Ü–µ–ª–µ–≤–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞
  var chosenIdx = pickIndexByWeight(prizes);
  var stopAngle = chosenIdx * arc + arc/2;
  var total = (Math.random()*5 + 8)*2*Math.PI + stopAngle;
  var start = null, duration = 6000;

  function frame(ts){
    if(!start) start = ts;
    var p = Math.min(1, (ts - start)/duration);
    var ease = 1 - Math.pow(1 - p, 4);
    var angle = ease * total;

    ctx.clearRect(0, 0, canvas.width, canvas.height);
    drawWheel(angle);

    if (p < 1){
      requestAnimationFrame(frame);
    } else {
      var current = angle % (2 * Math.PI);
      var winAngle = (2 * Math.PI - current) % (2 * Math.PI);
      var idx = Math.floor(winAngle / arc) % sectors;
      var prizeLabel = prizes[idx].label;;

      var memeUrl = '';
      if (prizeLabel === '–¥–∏—á—å –æ—Ç –ª–æ–≥–∏—Å—Ç–∞' && LOGIST_MEMES.length){
        memeUrl = LOGIST_MEMES[Math.floor(Math.random()*LOGIST_MEMES.length)];
      }

      var messageHTML = buildMessageHTML(prizeLabel, memeUrl);
      var modalText   = textForModal(prizeLabel);

      // –º–æ–¥–∞–ª–∫–∞
      resultText.textContent = modalText;
      if (memeUrl){
        memeImg.src = memeUrl; 
        memeImg.classList.remove('hidden'); 
        memeImg.style.display = 'block';
      } else {
        memeImg.removeAttribute('src'); 
        memeImg.classList.add('hidden'); 
        memeImg.style.display = 'none';
      }
      modal.classList.remove('hidden');

      var isSecondChance = (prizeLabel === '–≤—Ç–æ—Ä–æ–π —à–∞–Ω—Å');

      if (isSecondChance && !secondChanceConsumed){
        secondChanceAvailable = true;
        secondChanceConsumed = false;
        spinBtn.disabled = false;
        alreadyPlayed = true;
        hint.textContent = '–í–∞–º –≤—ã–ø–∞–ª –≤—Ç–æ—Ä–æ–π —à–∞–Ω—Å ‚Äî –º–æ–∂–Ω–æ –∫—Ä—É—Ç–∏—Ç—å –µ—â—ë —Ä–∞–∑!';
        try{ if(!DEV_MODE) localStorage.setItem(STORAGE_KEY, 'second_chance'); }catch(_){}
      } else {
        secondChanceAvailable = false;
        try{ if(!DEV_MODE) localStorage.setItem(STORAGE_KEY, '1'); }catch(_){}
        alreadyPlayed = !DEV_MODE;
        spinBtn.disabled = alreadyPlayed;
        if (!DEV_MODE && alreadyPlayed){
          hint.textContent = '–í—ã —É–∂–µ –∫—Ä—É—Ç–∏–ª–∏ –∫–æ–ª–µ—Å–æ –Ω–∞ —ç—Ç–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ.';
        } else {
          hint.textContent = '';
        }
      }

      usingSecondChanceNow = false;
      spinning = false;

      // –æ—Ç–ø—Ä–∞–≤–∫–∞ –≤ n8n
      postPrize({
        tg_id: TG_ID,
        username: USERNAME,
        prize: prizeLabel,
        message_html: messageHTML,
        meme_url: memeUrl,
        ts: Date.now(),
        event_id: String(TG_ID||'0') + '-' + String(Date.now())
      });
    }
  }
  requestAnimationFrame(frame);
}

    /* ===== INIT ===== */
    function init(){
      // DOM
      canvas     = document.getElementById('roulette');
      ctx        = canvas.getContext('2d');
      spinBtn    = document.getElementById('spin-btn');
      hint       = document.getElementById('hint');
      modal      = document.getElementById('result-modal');
      resultText = document.getElementById('result-text');
      memeImg    = document.getElementById('meme');
      closeModal = document.getElementById('close-modal');

      // reset –ø–æ –ø–∞—Ä–∞–º–µ—Ç—Ä—É
      try{ if (RESET_FLAG) localStorage.removeItem(STORAGE_KEY); }catch(_){}

      // ¬´1 —Ä–∞–∑¬ª (–∫—Ä–æ–º–µ dev) + –æ–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Ç–æ—Ä–æ–≥–æ —à–∞–Ω—Å–∞
      try{
        if (!DEV_MODE){
          var storedState = localStorage.getItem(STORAGE_KEY);
          if (storedState === '1'){
            alreadyPlayed = true;
            spinBtn.disabled = true;
            hint.textContent = '–í—ã —É–∂–µ –∫—Ä—É—Ç–∏–ª–∏ –∫–æ–ª–µ—Å–æ –Ω–∞ —ç—Ç–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ.';
          } else if (storedState === 'second_chance'){
            alreadyPlayed = true;
            secondChanceAvailable = true;
            secondChanceConsumed = false;
            hint.textContent = '–£ –≤–∞—Å –µ—Å—Ç—å –≤—Ç–æ—Ä–æ–π —à–∞–Ω—Å ‚Äî –≤–æ—Å–ø–æ–ª—å–∑—É–π—Ç–µ—Å—å –∏–º!';
          }
        }
      }catch(_){}

      // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ–ª–Ω—ã–π —Ä–∞–∑–º–µ—Ä —ç–∫—Ä–∞–Ω–∞ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
      setFullScreenSize();
      setTimeout(setFullScreenSize, 50);
      setTimeout(setFullScreenSize, 100);
      setTimeout(setFullScreenSize, 200);
      
      resizeCanvas();
      window.addEventListener('resize', function(){
        setFullScreenSize();
        resizeCanvas();
      });
      
      // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –≤—ã–∑–æ–≤—ã –¥–ª—è –≥–∞—Ä–∞–Ω—Ç–∏–∏
      window.addEventListener('orientationchange', function(){
        setTimeout(setFullScreenSize, 100);
        setTimeout(setFullScreenSize, 300);
      });
      // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è viewport –≤ Telegram WebApp (–¥–ª—è –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞)
      if (tg && tg.onEvent) {
        tg.onEvent('viewportChanged', function(){
          setTimeout(function(){
            setFullScreenSize();
            resizeCanvas();
          }, 100);
        });
      }
      spinBtn.addEventListener('click', spin);
      closeModal.addEventListener('click', function(){
        modal.classList.add('hidden');
        try{ tg && tg.close && tg.close(); }catch(_){}
      });
    }

    if (document.readyState === 'loading'){
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
  </script>
</body>
</html>






