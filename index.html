<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>–ö–æ–ª–µ—Å–æ –§–æ—Ä—Ç—É–Ω—ã</title>
  <style>
    :root{--bg1:#2c3e50;--bg2:#223043;--btn:#4c86ff;--btnText:#fff}
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;color:#fff;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Arial;
      display:flex;align-items:center;justify-content:center;
      background:radial-gradient(1000px 600px at 50% 0%, #34495e 0%, var(--bg1) 50%, var(--bg2) 100%)}
    .container{text-align:center;padding:16px}
    h1{margin:0 0 18px;font-weight:800;letter-spacing:.2px}
    .wheel-wrap{position:relative;width:350px;margin:0 auto}
    canvas{display:block;width:350px;height:350px;margin:0 auto;background:transparent}
    /* –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–∞—è —Å—Ç—Ä–µ–ª–∫–∞ */
    #pointer{position:absolute;top:50%;right:-6px;transform:translateY(-50%);
      width:0;height:0;border-top:12px solid transparent;border-bottom:12px solid transparent;
      border-left:26px solid #ff3b30;filter:drop-shadow(0 2px 2px rgba(0,0,0,.4))}
    #spin-btn{margin-top:22px;padding:14px 28px;font-size:16px;font-weight:700;cursor:pointer;
      border:none;border-radius:12px;background:var(--btn);color:var(--btnText);
      box-shadow:0 10px 24px rgba(76,134,255,.35), inset 0 0 0 1px rgba(255,255,255,.12);
      transition:transform .08s ease, filter .2s ease}
    #spin-btn:hover{filter:brightness(1.06)} #spin-btn:active{transform:translateY(1px)}
    #spin-btn:disabled{background:#8a8a8a;cursor:not-allowed;box-shadow:none}
    .hint{opacity:.85;font-size:13px;margin:10px 0 0}
    /* –º–æ–¥–∞–ª–∫–∞ */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.55);
      display:flex;align-items:center;justify-content:center;padding:16px}
    .hidden{display:none}
    .modal-card{width:min(520px, 92vw);background:#1e2736;border-radius:16px;padding:22px 20px;
      box-shadow:0 12px 30px rgba(0,0,0,.45);text-align:left}
    .modal-title{font-size:18px;font-weight:800;margin:0 0 10px}
    .modal-text{font-size:16px;line-height:1.6;color:#e9eef9;margin:0;white-space:pre-line;letter-spacing:.2px}
    .modal-text b{color:#fff}
    .modal-btn{margin-top:16px;padding:12px 18px;border:none;border-radius:10px;background:#36b37e;
      color:#fff;font-weight:700;cursor:pointer;box-shadow:0 6px 16px rgba(54,179,126,.35)}
    .meme{display:block;width:100%;max-height:360px;object-fit:contain;margin-top:14px;border-radius:10px}
  </style>
</head>
<body>
  <div class="container">
    <h1>–ò—Å–ø—ã—Ç–∞–π —Å–≤–æ—é —É–¥–∞—á—É!</h1>
    <div class="wheel-wrap">
      <canvas id="roulette" width="350" height="350"></canvas>
      <div id="pointer"></div>
    </div>
    <button id="spin-btn">–ö—Ä—É—Ç–∏—Ç—å!</button>
    <p id="hint" class="hint"></p>
  </div>

  <!-- –º–æ–¥–∞–ª–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ -->
  <div id="result-modal" class="modal hidden">
    <div class="modal-card">
      <div class="modal-title">–í–∞—à –ø—Ä–∏–∑</div>
      <div id="result-text" class="modal-text"></div>
      <img id="meme" class="meme hidden" alt="–º–µ–º"/>
      <button id="close-modal" class="modal-btn">–ü–æ–Ω—è—Ç–Ω–æ</button>
    </div>
  </div>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script>
    /* ========= –ù–ê–°–¢–†–û–ô–ö–ò ========= */
    // –ø—Ä–æ–¥-–≤–µ–±—Ö—É–∫ n8n
    var WEBHOOK_URL = 'https://solonflowai.ru/webhook/roulette_prize';

    // –º–µ–º—ã –¥–ª—è ¬´–¥–∏—á—å –æ—Ç –ª–æ–≥–∏—Å—Ç–∞¬ª (–¥–æ–±–∞–≤—å 1‚Äì5 —Å—Å—ã–ª–æ–∫)
    var LOGIST_MEMES = [
      // 'https://example.com/meme1.jpg',
      // 'https://example.com/meme2.png',
    ];

    /* ========= Telegram SDK ========= */
    var tg = (window.Telegram && window.Telegram.WebApp) ? window.Telegram.WebApp : null;
    try{ tg && tg.ready && tg.ready(); }catch(_){}
    var user = (tg && tg.initDataUnsafe && tg.initDataUnsafe.user) ? tg.initDataUnsafe.user : null;
    var TG_ID = user ? user.id : null;
    var USERNAME = user ? user.username : null;

    /* ========= DOM ========= */
    var canvas = document.getElementById('roulette');
    var ctx = canvas.getContext('2d');
    var spinBtn = document.getElementById('spin-btn');

var hint = document.getElementById('hint');
    var modal = document.getElementById('result-modal');
    var resultText = document.getElementById('result-text');
    var memeImg = document.getElementById('meme');
    var closeModal = document.getElementById('close-modal');

    /* ========= –î–ê–ù–ù–´–ï –°–ï–ö–¢–û–†–û–í ========= */
    var prizes = [
      { label: '—Å–æ–∫ –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç–∏', color: '#ff6b6b' },
      { label: '–±—ã—Å—Ç—Ä–∞—è –ø–æ–ª–∫–∞',     color: '#feca57' },
      { label: '–ø—Ä—è–º–æ–π –ø–µ—Ä–µ–≤–æ–¥',    color: '#48dbfb' },
      { label: '–¥–∏—á—å –æ—Ç –ª–æ–≥–∏—Å—Ç–∞',   color: '#1dd1a1' }
    ];

    var sectors = prizes.length;
    var arc = (2*Math.PI)/sectors;
    var spinning = false;
    var DPR = Math.max(1, window.devicePixelRatio || 1);
    var VISUAL_SIZE = 350;
    var alreadyPlayed = false;

    /* ========= –¢–ï–ö–°–¢ –î–õ–Ø –ß–ê–¢–ê (HTML) ========= */
    function buildMessageHTML(prizeLabel){
      if (prizeLabel === '—Å–æ–∫ –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç–∏')
        return 'üéâ <b>–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º!</b> –í–∞–º –≤—ã–ø–∞–ª –ø—Ä–∏–∑: üßÉ <b>–°–æ–∫ –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç–∏</b>\\n\\nüí∏ 100 ‚ÇΩ –Ω–∞ –∫–∞—Ä—Ç—É.\\nüì© –ü—Ä–∏—à–ª–∏—Ç–µ —Å–∫—Ä–∏–Ω –≤–∞—à–µ–º—É –ª–æ–≥–∏—Å—Ç—É ‚Äî –æ–Ω –≤—Å—ë –æ—Ä–≥–∞–Ω–∏–∑—É–µ—Ç.';
      if (prizeLabel === '–±—ã—Å—Ç—Ä–∞—è –ø–æ–ª–∫–∞')
        return 'üéâ <b>–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º!</b> –í–∞–º –≤—ã–ø–∞–ª –ø—Ä–∏–∑: üöÄ <b>–ë—ã—Å—Ç—Ä–∞—è –ø–æ–ª–∫–∞</b>\\n\\nüì¶ –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –Ω–∞ —Å–ª–µ–¥—É—é—â—É—é –¥–æ—Å—Ç–∞–≤–∫—É.\\nüì© –ü—Ä–∏—à–ª–∏—Ç–µ —Å–∫—Ä–∏–Ω –≤–∞—à–µ–º—É –ª–æ–≥–∏—Å—Ç—É ‚Äî –æ–Ω –≤—Å—ë –æ—Ä–≥–∞–Ω–∏–∑—É–µ—Ç.';
      if (prizeLabel === '–ø—Ä—è–º–æ–π –ø–µ—Ä–µ–≤–æ–¥')
        return 'üéâ <b>–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º!</b> –í–∞–º –≤—ã–ø–∞–ª –ø—Ä–∏–∑: üí≥ <b>–ü—Ä—è–º–æ–π –ø–µ—Ä–µ–≤–æ–¥</b>\\n\\nüíµ 300 ‚ÇΩ –Ω–∞ –∫–∞—Ä—Ç—É.\\nüì© –ü—Ä–∏—à–ª–∏—Ç–µ —Å–∫—Ä–∏–Ω –≤–∞—à–µ–º—É –ª–æ–≥–∏—Å—Ç—É ‚Äî –æ–Ω –≤—Å—ë –æ—Ä–≥–∞–Ω–∏–∑—É–µ—Ç.';
      if (prizeLabel === '–¥–∏—á—å –æ—Ç –ª–æ–≥–∏—Å—Ç–∞')
        return 'üéâ <b>–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º!</b> –í–∞–º –≤—ã–ø–∞–ª –ø—Ä–∏–∑: üòÇ <b>–î–∏—á—å –æ—Ç –ª–æ–≥–∏—Å—Ç–∞</b>\\n\\n–õ–æ–≤–∏ –º–µ–º! üòâ';
      return 'üéâ <b>–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º!</b> –í–∞—à –ø—Ä–∏–∑: ' + prizeLabel;
    }

    /* ========= –¢–ï–ö–°–¢ –î–õ–Ø –ú–û–î–ê–õ–ö–ò ========= */
    function textForModal(prizeLabel){
      if (prizeLabel === '—Å–æ–∫ –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç–∏')
        return '–°–æ–∫ –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç–∏ ‚Äî 100 —Ä—É–±. –Ω–∞ –∫–∞—Ä—Ç—É.\\n–ü—Ä–∏—à–ª–∏—Ç–µ —Å–∫—Ä–∏–Ω –≤–∞—à–µ–º—É –ª–æ–≥–∏—Å—Ç—É ‚Äî –æ–Ω –≤—Å—ë –æ—Ä–≥–∞–Ω–∏–∑—É–µ—Ç.';
      if (prizeLabel === '–±—ã—Å—Ç—Ä–∞—è –ø–æ–ª–∫–∞')
        return '–ë—ã—Å—Ç—Ä–∞—è –ø–æ–ª–∫–∞ ‚Äî –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –Ω–∞ —Å–ª–µ–¥—É—é—â—É—é –¥–æ—Å—Ç–∞–≤–∫—É.\\n–ü—Ä–∏—à–ª–∏—Ç–µ —Å–∫—Ä–∏–Ω –≤–∞—à–µ–º—É –ª–æ–≥–∏—Å—Ç—É ‚Äî –æ–Ω –≤—Å—ë –æ—Ä–≥–∞–Ω–∏–∑—É–µ—Ç.';
      if (prizeLabel === '–ø—Ä—è–º–æ–π –ø–µ—Ä–µ–≤–æ–¥')
        return '–ü—Ä—è–º–æ–π –ø–µ—Ä–µ–≤–æ–¥ ‚Äî 300 —Ä—É–±. –Ω–∞ –∫–∞—Ä—Ç—É.\\n–ü—Ä–∏—à–ª–∏—Ç–µ —Å–∫—Ä–∏–Ω –≤–∞—à–µ–º—É –ª–æ–≥–∏—Å—Ç—É ‚Äî –æ–Ω –≤—Å—ë –æ—Ä–≥–∞–Ω–∏–∑—É–µ—Ç.';
      if (prizeLabel === '–¥–∏—á—å –æ—Ç –ª–æ–≥–∏—Å—Ç–∞')
        return '–î–∏—á—å –æ—Ç –ª–æ–≥–∏—Å—Ç–∞ ‚Äî –ª–æ–≤–∏ –º–µ–º üòÑ';
      return prizeLabel;
    }

    /* ========= CANVAS ========= */
    function resizeCanvas(){
      var vw = Math.min(380, Math.floor(window.innerWidth*0.9));
      VISUAL_SIZE = Math.max(260, vw);
      canvas.style.width = VISUAL_SIZE+'px';
      canvas.style.height = VISUAL_SIZE+'px';
      canvas.width = Math.floor(VISUAL_SIZE*DPR);
      canvas.height = Math.floor(VISUAL_SIZE*DPR);
      ctx.setTransform(1,0,0,1,0,0);
      ctx.scale(DPR, DPR);
      ctx.imageSmoothingEnabled = true;
      drawStatic();
    }
    window.addEventListener('resize', resizeCanvas);

    function drawWheel(angle){
      var W = VISUAL_SIZE, H = VISUAL_SIZE;
      var cx=W/2, cy=H/2, r=Math.min(cx,cy)-8;

      ctx.save(); ctx.translate(cx,cy); ctx.rotate(angle||0); ctx.translate(-cx,-cy);
      for (var i=0;i<sectors;i++){
        var a0=i*arc, a1=a0+arc;
        ctx.beginPath(); ctx.moveTo(cx,cy);
        ctx.fillStyle=prizes[i].color; ctx.arc(cx,cy,r,a0,a1); ctx.closePath(); ctx.fill();

        ctx.strokeStyle='rgba(0,0,0,.15)'; ctx.lineWidth=1;
        ctx.beginPath(); ctx.arc(cx,cy,r,a0,a1); ctx.stroke();

        ctx.save(); ctx.translate(cx,cy); ctx.rotate(a0+arc/2);
        ctx.fillStyle='#fff'; ctx.textAlign='center'; ctx.textBaseline='middle';
        ctx.font='600 16px -apple-system, Segoe UI, Roboto, Arial';
        ctx.shadowColor='rgba(0,0,0,.35)'; ctx.shadowBlur=1.5;
        ctx.fillText(prizes[i].label, r*0.58, 0);
        ctx.restore();
      }
      ctx.restore();

      ctx.lineWidth=6; ctx.strokeStyle='rgba(255,255,255,.9)';
      ctx.beginPath(); ctx.arc(cx,cy,r+2,0,Math.PI*2); ctx.stroke();

      ctx.fillStyle='#e5ecff'; ctx.beginPath(); ctx.arc(cx,cy,14,0,Math.PI*2); ctx.

fill();
      ctx.strokeStyle='rgba(0,0,0,.12)'; ctx.lineWidth=1; ctx.stroke();
    }
    function drawStatic(){ ctx.clearRect(0,0,canvas.width,canvas.height); drawWheel(0); }

    /* ========= –í–ï–ë–•–£–ö ========= */
    function postPrize(payload){
      return fetch(WEBHOOK_URL, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        keepalive:true,
        body: JSON.stringify(payload)
      }).catch(()=>{});
    }

    /* ========= –°–ü–ò–ù ========= */
    function spin(){
      if (spinning) return;
      // –ª–æ–∫–∞–ª—å–Ω–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ (–∫—Ä–æ–º–µ —Ä–µ–∂–∏–º–∞ dev=1)
      var params = new URLSearchParams(location.search);
      var DEV = params.get('dev') === '1';
      if (!DEV && alreadyPlayed) return;

      spinning = true; spinBtn.disabled = true;

      var total = (Math.random()*5 + 8)*2*Math.PI + Math.random()*2*Math.PI;
      var start=null, duration=6000;

      function frame(ts){
        if(!start) start = ts;
        var p=Math.min(1,(ts-start)/duration);
        var ease=1-Math.pow(1-p,4);
        var angle=ease*total;

        ctx.clearRect(0,0,canvas.width,canvas.height);
        drawWheel(angle);

        if(p<1){ requestAnimationFrame(frame); }
        else{
          var current = angle%(2*Math.PI);
          var winAngle = (2*Math.PI - current)%(2*Math.PI);
          var idx = Math.floor(winAngle/arc)%sectors;
          var prizeLabel = prizes[idx].label;

          // —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è —á–∞—Ç–∞ (HTML) –∏ –¥–ª—è –º–æ–¥–∞–ª–∫–∏
          var messageHTML = buildMessageHTML(prizeLabel);
          var modalText = textForModal(prizeLabel);

          // –º–µ–º (–µ—Å–ª–∏ –Ω—É–∂–µ–Ω)
          var memeUrl = '';
          if (prizeLabel === '–¥–∏—á—å –æ—Ç –ª–æ–≥–∏—Å—Ç–∞' && LOGIST_MEMES.length){
            memeUrl = LOGIST_MEMES[Math.floor(Math.random()*LOGIST_MEMES.length)];
          }

          // –ø–æ–∫–∞–∑–∞—Ç—å –º–æ–¥–∞–ª–∫—É
          resultText.textContent = modalText;
          if (memeUrl){
            memeImg.src = memeUrl; memeImg.classList.remove('hidden'); memeImg.style.display='block';
          } else {
            memeImg.removeAttribute('src'); memeImg.classList.add('hidden'); memeImg.style.display='none';
          }
          modal.classList.remove('hidden');

          // –ª–æ–∫-1-—Ä–∞–∑
          try{ if(!DEV) localStorage.setItem('roulette_played','1'); }catch(_){}
          alreadyPlayed = !DEV;

          // –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ n8n
          postPrize({
            tg_id: TG_ID,
            username: USERNAME,
            prize: prizeLabel,          // –∫–æ—Ä–æ—Ç–∫–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ
            message_html: messageHTML,  // –≥–æ—Ç–æ–≤—ã–π –∫—Ä–∞—Å–∏–≤—ã–π —Ç–µ–∫—Å—Ç
            meme_url: memeUrl,          // –µ—Å–ª–∏ –µ—Å—Ç—å
            ts: Date.now(),
            event_id: String(TG_ID||'0')+'-'+String(Date.now())
          });
        }
      }
      requestAnimationFrame(frame);
    }

    /* ========= INIT ========= */
    (function init(){
      try{
        var params = new URLSearchParams(location.search);
        var DEV = params.get('dev') === '1';
        if (!DEV && localStorage.getItem('roulette_played')==='1'){
          alreadyPlayed = true; spinBtn.disabled = true;
          hint.textContent = '–í—ã —É–∂–µ –∫—Ä—É—Ç–∏–ª–∏ –∫–æ–ª–µ—Å–æ –Ω–∞ —ç—Ç–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ.';
        }
      }catch(_){}
      resizeCanvas();
      spinBtn.addEventListener('click', spin);
      closeModal.addEventListener('click', function(){
        modal.classList.add('hidden');
        try{ tg && tg.close && tg.close(); }catch(_){}
      });
    })();
  </script>
</body>
</html>
