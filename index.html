<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>–ö–æ–ª–µ—Å–æ –§–æ—Ä—Ç—É–Ω—ã</title>
  <style>
    :root{--bg1:#2c3e50;--bg2:#223043;--btn:#4c86ff;--btnText:#fff}
    *{box-sizing:border-box} html,body{height:100%}
    body{
      margin:0;color:#fff;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Arial;
      display:flex;align-items:center;justify-content:center;
      background:radial-gradient(1000px 600px at 50% 0%,#34495e 0%,var(--bg1) 50%,var(--bg2) 100%)
    }
    .container{text-align:center;padding:16px}
    h1{margin:0 0 18px;font-weight:800;letter-spacing:.2px}

    .wheel-wrap{position:relative;width:350px;margin:0 auto}
    canvas{display:block;width:350px;height:350px;margin:0 auto;background:transparent}

    /* –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–∞—è —Å—Ç—Ä–µ–ª–∫–∞ */
    #pointer{
      position:absolute;top:50%;right:-6px;transform:translateY(-50%);
      width:0;height:0;border-top:12px solid transparent;border-bottom:12px solid transparent;
      border-left:26px solid #ff3b30;filter:drop-shadow(0 2px 2px rgba(0,0,0,.4))
    }

    #spin-btn{
      margin-top:22px;padding:14px 28px;font-size:16px;font-weight:700;cursor:pointer;
      border:none;border-radius:12px;background:var(--btn);color:var(--btnText);
      box-shadow:0 10px 24px rgba(76,134,255,.35),inset 0 0 0 1px rgba(255,255,255,.12);
      transition:transform .08s ease,filter .2s ease
    }
    #spin-btn:hover{filter:brightness(1.06)}
    #spin-btn:active{transform:translateY(1px)}
    #spin-btn:disabled{background:#8a8a8a;cursor:not-allowed;box-shadow:none}
    .hint{opacity:.85;font-size:13px;margin:10px 0 0}

    /* –º–æ–¥–∞–ª–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.55);
      display:flex;align-items:center;justify-content:center;padding:16px}
    .hidden{display:none}
    .modal-card{width:min(520px,92vw);background:#1e2736;border-radius:16px;padding:22px 20px;
      box-shadow:0 12px 30px rgba(0,0,0,.45);text-align:left}
    .modal-title{font-size:18px;font-weight:800;margin:0 0 10px}
    .modal-text{font-size:16px;line-height:1.6;color:#e9eef9;margin:0;white-space:pre-line;letter-spacing:.2px}
    .modal-text b{color:#fff}
    .modal-btn{margin-top:16px;padding:12px 18px;border:none;border-radius:10px;background:#36b37e;
      color:#fff;font-weight:700;cursor:pointer;box-shadow:0 6px 16px rgba(54,179,126,.35)}
    .meme{display:block;width:100%;max-height:360px;object-fit:contain;margin-top:14px;border-radius:10px}

    /* –Ω–∞ –¥–µ—Å–∫—Ç–æ–ø–∞—Ö ‚Äî –±–æ–ª—å—à–µ —Å—Ç–∞—Ä—Ç–æ–≤—ã–π —Ä–∞–∑–º–µ—Ä */
    @media (min-width:1024px){
      .wheel-wrap{width:440px}
      canvas{width:440px;height:440px}
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>–ò—Å–ø—ã—Ç–∞–π —Å–≤–æ—é —É–¥–∞—á—É!</h1>
    <div class="wheel-wrap">
      <canvas id="roulette" width="350" height="350"></canvas>
      <div id="pointer"></div>
    </div>
    <button id="spin-btn">–ö—Ä—É—Ç–∏—Ç—å!</button>
    <p id="hint" class="hint"></p>
  </div>

  <!-- –º–æ–¥–∞–ª–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ -->
  <div id="result-modal" class="modal hidden">
    <div class="modal-card">
      <div class="modal-title">–í–∞—à –ø—Ä–∏–∑</div>
      <div id="result-text" class="modal-text"></div>
      <img id="meme" class="meme hidden" alt="–º–µ–º"/>
      <button id="close-modal" class="modal-btn">–ü–æ–Ω—è—Ç–Ω–æ</button>
    </div>
  </div>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script>
    /* ===== –ù–ê–°–¢–†–û–ô–ö–ê ===== */
    // –ø—Ä–æ–¥-–≤–µ–±—Ö—É–∫ n8n ‚Äî –ø–æ–º–µ–Ω—è–π –Ω–∞ —Å–≤–æ–π –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
    var WEBHOOK_URL = 'https://solonflowai.ru/webhook/roulette_prize';

    // –º–µ–º—ã –¥–ª—è ¬´–¥–∏—á—å –æ—Ç –ª–æ–≥–∏—Å—Ç–∞¬ª (–ø–æ –∂–µ–ª–∞–Ω–∏—é –¥–æ–±–∞–≤—å —Å—Å—ã–ª–∫–∏)
    var LOGIST_MEMES = [
      // 'https://example.com/meme1.jpg',
      // 'https://example.com/meme2.png',
"https://github.com/nikitasolonukha/my-roulette/blob/main/%D0%BC%D0%B5%D0%BC%D1%8B%20%D1%80%D1%83%D0%BB%D0%B5%D1%82%D0%BA%D0%B0/1%20%D0%BC%D0%B5%D0%BC.PNG?raw=true",
"https://github.com/nikitasolonukha/my-roulette/blob/main/%D0%BC%D0%B5%D0%BC%D1%8B%20%D1%80%D1%83%D0%BB%D0%B5%D1%82%D0%BA%D0%B0/2%20%D0%BC%D0%B5%D0%BC.PNG?raw=true",
"https://github.com/nikitasolonukha/my-roulette/blob/main/%D0%BC%D0%B5%D0%BC%D1%8B%20%D1%80%D1%83%D0%BB%D0%B5%D1%82%D0%BA%D0%B0/3%20%D0%BC%D0%B5%D0%BC.PNG?raw=true",
"https://github.com/nikitasolonukha/my-roulette/blob/main/%D0%BC%D0%B5%D0%BC%D1%8B%20%D1%80%D1%83%D0%BB%D0%B5%D1%82%D0%BA%D0%B0/4%20%D0%BC%D0%B5%D0%BC.PNG?raw=true",
"https://github.com/nikitasolonukha/my-roulette/blob/main/%D0%BC%D0%B5%D0%BC%D1%8B%20%D1%80%D1%83%D0%BB%D0%B5%D1%82%D0%BA%D0%B0/5%20%D0%BC%D0%B5%D0%BC.PNG?raw=true"
    ];

    /* ===== Telegram SDK ===== */
    var tg = (window.Telegram && window.Telegram.WebApp) ? window.Telegram.WebApp : null;
    try{ tg && tg.ready && tg.ready(); }catch(_){}
    var user = (tg && tg.initDataUnsafe && tg.initDataUnsafe.user) ? tg.initDataUnsafe.user : null;
    var TG_ID = user ? user.id : null;
    var USERNAME = user ? user.username : null;

    /* ===== –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ñ–ª–∞–≥ ¬´–∫—Ä—É—Ç–∏–ª¬ª + dev/reset ===== */
    var urlParams   = new URLSearchParams(location.search);
    var APP_VERSION = urlParams.get('v') || '1';
    var DEV_MODE    = urlParams.get('dev') === '1';
    var RESET_FLAG  = urlParams.get('reset') === '1';
    var STORAGE_KEY = 'roulette_played_v' + APP_VERSION;

    /* ===== DOM ===== */
    var canvas, ctx, spinBtn, hint, modal, resultText, memeImg, closeModal;

    /* ===== –î–ê–ù–ù–´–ï –°–ï–ö–¢–û–†–û–í ===== */
    var prizes = [
  { label: '–¥–∏—á—å –æ—Ç –ª–æ–≥–∏—Å—Ç–∞',   color: '#1dd1a1', weight: 5 }, // –º–µ–º—ã ‚Äî —á–∞—â–µ
  { label: '—Å–æ–∫ –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç–∏', color: '#ff6b6b', weight: 3 }, // 100 ‚ÇΩ
  { label: '–±—ã—Å—Ç—Ä–∞—è –ø–æ–ª–∫–∞',     color: '#feca57', weight: 2 }, // –¥–æ—Å—Ç–∞–≤–∫–∞
  { label: '–ø—Ä—è–º–æ–π –ø–µ—Ä–µ–≤–æ–¥',    color: '#48dbfb', weight: 1 }  // 300 ‚ÇΩ ‚Äî —Ä–µ–∂–µ –≤—Å–µ–≥–æ
];
    var sectors = prizes.length;
    var arc = (2*Math.PI)/sectors;

    /* ===== –ì–ï–û–ú–ï–¢–†–ò–Ø/–û–¢–†–ò–°–û–í–ö–ê ===== */
    var spinning = false;
    var alreadyPlayed = false;
    var DPR = 1;
    var VISUAL_SIZE = 350; // CSS-–ø–∏–∫—Å–µ–ª–∏

    function getEffectiveDPR(){
      var dv = (window.devicePixelRatio || 1);
      var vs = (window.visualViewport && window.visualViewport.scale) ? window.visualViewport.scale : 1;
      return Math.max(1, Math.round(dv * vs)); // —Ü–µ–ª–æ–µ => —á—ë—Ç—á–µ
    }

    function resizeCanvas(){
      // –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π —Ä–∞–∑–º–µ—Ä –æ—Ç —à–∏—Ä–∏–Ω—ã –∏ –≤—ã—Å–æ—Ç—ã –æ–∫–Ω–∞
      var w = Math.floor(window.innerWidth  * 0.92);
      var h = Math.floor(window.innerHeight * 0.55);
      var side = Math.min(480, Math.max(280, Math.min(w, h)));
      VISUAL_SIZE = side;

      canvas.style.width  = VISUAL_SIZE + 'px';
      canvas.style.height = VISUAL_SIZE + 'px';

      DPR = getEffectiveDPR();
      canvas.width  = VISUAL_SIZE * DPR;
      canvas.height = VISUAL_SIZE * DPR;

      ctx.setTransform(1,0,0,1,0,0);
      ctx.scale(DPR, DPR);
      ctx.imageSmoothingEnabled = true;

      drawStatic();
    }

    // –•–µ–ª–ø–µ—Ä: –∞–≤—Ç–æ-–ø–æ–¥–≥–æ–Ω —à—Ä–∏—Ñ—Ç–∞ + –ø–µ—Ä–µ–Ω–æ—Å –¥–æ –¥–≤—É—Ö —Å—Ç—Ä–æ–∫
    function fitLabelToSector(ctx, label, maxWidthPx, baseFontPx, minFontPx) {
      let fontPx = baseFontPx;
      while (fontPx >= minFontPx) {
        ctx.font = `600 ${fontPx}px -apple-system, Segoe UI, Roboto, Arial`;
        if (ctx.measureText(label).width <= maxWidthPx) {
          return { lines: [label], fontPx };
        }
        fontPx -= 1;
      }
      const words = label.split(' ');
      if (words.length === 1) return { lines: [label], fontPx: minFontPx };

      for (let cut = 1; cut < words.length; cut++) {
        const l1 = words.slice(0, cut).join(' ');
        const l2 = words.slice(cut).join(' ');
        let fp = baseFontPx;
        while (fp >= minFontPx) {
          ctx.font = `600 ${fp}px -apple-system, Segoe UI, Roboto, Arial`;
          if (Math.max(ctx.measureText(l1).width, ctx.measureText(l2).width) <= maxWidthPx) {
            return { lines: [l1, l2], fontPx: fp };
          }
          fp -= 1;
        }
      }
      return { lines: [label], fontPx: minFontPx };
    }

    function drawWheel(angle){
      var W = VISUAL_SIZE, H = VISUAL_SIZE;

      // ¬´–ø—Ä–∏—â—ë–ª–∫–Ω—É—Ç—ã–µ¬ª –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –¥–ª—è —á—ë—Ç–∫–∏—Ö –ª–∏–Ω–∏–π
      var cx = Math.floor(W/2) + 0.5;
      var cy = Math.floor(H/2) + 0.5;
      var r  = Math.floor(Math.min(cx, cy) - 8) + 0.5;

      ctx.save();
      ctx.translate(cx, cy);
      ctx.rotate(angle || 0);
      ctx.translate(-cx, -cy);

      for (var i=0;i<sectors;i++){
        var a0 = i*arc, a1 = a0 + arc;

        // —Å–µ–∫—Ç–æ—Ä
        ctx.beginPath();
        ctx.moveTo(cx, cy);
        ctx.fillStyle = prizes[i].color;
        ctx.arc(cx, cy, r, a0, a1);
        ctx.closePath();
        ctx.fill();

        // –≥—Ä–∞–Ω–∏—Ü–∞ —Å–µ–∫—Ç–æ—Ä–∞
        ctx.strokeStyle = 'rgba(0,0,0,.15)';
        ctx.lineWidth = 1;
        ctx.beginPath();
        ctx.arc(cx, cy, r, a0, a1);
        ctx.stroke();

        // –ø–æ–¥–ø–∏—Å—å ‚Äî –∫—Ä—É–ø–Ω–∞—è, —á–∏—Ç–∞–µ–º–∞—è, –Ω–æ –Ω–µ –≤—ã–ª–µ–∑–∞–µ—Ç
        ctx.save();
        ctx.translate(cx, cy);
        ctx.rotate(a0 + arc/2);
        ctx.fillStyle = '#fff';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';

        // –¥–∏–Ω–∞–º–∏–∫–∞ –æ—Ç —Ä–∞–¥–∏—É—Å–∞
        const baseFontPx = Math.round(Math.min(22, Math.max(13, r * 0.065)));
        const minFontPx  = Math.max(11, baseFontPx - 5);

        const maxTextWidth = r * 0.70; // –±–µ–∑–æ–ø–∞—Å–Ω–∞—è —à–∏—Ä–∏–Ω–∞
        const tx           = r * 0.55; // —á—É—Ç—å –≥–ª—É–±–∂–µ –≤–Ω—É—Ç—Ä—å —Å–µ–∫—Ç–æ—Ä–∞

        const fitted = fitLabelToSector(ctx, prizes[i].label, maxTextWidth, baseFontPx, minFontPx);
        ctx.font = `600 ${fitted.fontPx}px -apple-system, Segoe UI, Roboto, Arial`;

        // –ª—ë–≥–∫–∞—è —Ç–µ–Ω—å: –Ω–∞ –º–æ–±–∏–ª–∫–∞—Ö —Å–ª–∞–±–µ–µ
        var isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
        ctx.shadowColor = isMobile ? 'rgba(0,0,0,.2)' : 'rgba(0,0,0,.28)';
        ctx.shadowBlur  = isMobile ? 0.6 : 1.1;

        if (fitted.lines.length === 1){
          ctx.fillText(fitted.lines[0], tx, 0);
        } else {
          const lh = fitted.fontPx + 2;
          ctx.fillText(fitted.lines[0], tx, -lh/2);
          ctx.fillText(fitted.lines[1], tx,  lh/2);
        }
        ctx.restore();
      }
      ctx.restore();

      // –±–µ–ª—ã–π –æ–±–æ–¥–æ–∫
      ctx.lineWidth = 6;
      ctx.strokeStyle = 'rgba(255,255,255,.9)';
      ctx.beginPath(); ctx.arc(cx, cy, r+2, 0, Math.PI*2); ctx.stroke();

      // —Ü–µ–Ω—Ç—Ä
      ctx.fillStyle = '#e5ecff';
      ctx.beginPath(); ctx.arc(cx, cy, 14, 0, Math.PI*2); ctx.fill();
      ctx.strokeStyle = 'rgba(0,0,0,.12)'; ctx.lineWidth = 1; ctx.stroke();
    }
    function drawStatic(){ ctx.clearRect(0,0,canvas.width,canvas.height); drawWheel(0); }

    /* ===== –¢–ï–ö–°–¢–´ ===== */
    function buildMessageHTML(prizeLabel){
      if (prizeLabel === '—Å–æ–∫ –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç–∏')
        return 'üéâ <b>–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º!</b> –í–∞–º –≤—ã–ø–∞–ª –ø—Ä–∏–∑: üßÉ <b>–°–æ–∫ –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç–∏</b>\n\nüí∏ 100 ‚ÇΩ –Ω–∞ –∫–∞—Ä—Ç—É.\nüì© –ü—Ä–∏—à–ª–∏—Ç–µ —Å–∫—Ä–∏–Ω –≤–∞—à–µ–º—É –ª–æ–≥–∏—Å—Ç—É ‚Äî –æ–Ω –≤—Å—ë –æ—Ä–≥–∞–Ω–∏–∑—É–µ—Ç.';
      if (prizeLabel === '–±—ã—Å—Ç—Ä–∞—è –ø–æ–ª–∫–∞')
        return 'üéâ <b>–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º!</b> –í–∞–º –≤—ã–ø–∞–ª –ø—Ä–∏–∑: üöÄ <b>–ë—ã—Å—Ç—Ä–∞—è –ø–æ–ª–∫–∞</b>\n\nüì¶ –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –Ω–∞ —Å–ª–µ–¥—É—é—â—É—é –¥–æ—Å—Ç–∞–≤–∫—É.\nüì© –ü—Ä–∏—à–ª–∏—Ç–µ —Å–∫—Ä–∏–Ω –≤–∞—à–µ–º—É –ª–æ–≥–∏—Å—Ç—É ‚Äî –æ–Ω –≤—Å—ë –æ—Ä–≥–∞–Ω–∏–∑—É–µ—Ç.';
      if (prizeLabel === '–ø—Ä—è–º–æ–π –ø–µ—Ä–µ–≤–æ–¥')
        return 'üéâ <b>–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º!</b> –í–∞–º –≤—ã–ø–∞–ª –ø—Ä–∏–∑: üí≥ <b>–ü—Ä—è–º–æ–π –ø–µ—Ä–µ–≤–æ–¥</b>\n\nüíµ 300 ‚ÇΩ –Ω–∞ –∫–∞—Ä—Ç—É.\nüì© –ü—Ä–∏—à–ª–∏—Ç–µ —Å–∫—Ä–∏–Ω –≤–∞—à–µ–º—É –ª–æ–≥–∏—Å—Ç—É ‚Äî –æ–Ω –≤—Å—ë –æ—Ä–≥–∞–Ω–∏–∑—É–µ—Ç.';
      if (prizeLabel === '–¥–∏—á—å –æ—Ç –ª–æ–≥–∏—Å—Ç–∞')
        return 'üéâ <b>–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º!</b> –í–∞–º –≤—ã–ø–∞–ª –ø—Ä–∏–∑: üòÇ <b>–î–∏—á—å –æ—Ç –ª–æ–≥–∏—Å—Ç–∞</b>\n\n–õ–æ–≤–∏ –º–µ–º! üòâ';
      return 'üéâ <b>–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º!</b> –í–∞—à –ø—Ä–∏–∑: ' + prizeLabel;
    }
    function textForModal(prizeLabel){
      if (prizeLabel === '—Å–æ–∫ –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç–∏')
        return '–°–æ–∫ –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç–∏ ‚Äî 100 —Ä—É–±. –Ω–∞ –∫–∞—Ä—Ç—É.\n–ü—Ä–∏—à–ª–∏—Ç–µ —Å–∫—Ä–∏–Ω –≤–∞—à–µ–º—É –ª–æ–≥–∏—Å—Ç—É ‚Äî –æ–Ω –≤—Å—ë –æ—Ä–≥–∞–Ω–∏–∑—É–µ—Ç.';
      if (prizeLabel === '–±—ã—Å—Ç—Ä–∞—è –ø–æ–ª–∫–∞')
        return '–ë—ã—Å—Ç—Ä–∞—è –ø–æ–ª–∫–∞ ‚Äî –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –Ω–∞ —Å–ª–µ–¥—É—é—â—É—é –¥–æ—Å—Ç–∞–≤–∫—É.\n–ü—Ä–∏—à–ª–∏—Ç–µ —Å–∫—Ä–∏–Ω –≤–∞—à–µ–º—É –ª–æ–≥–∏—Å—Ç—É ‚Äî –æ–Ω –≤—Å—ë –æ—Ä–≥–∞–Ω–∏–∑—É–µ—Ç.';
      if (prizeLabel === '–ø—Ä—è–º–æ–π –ø–µ—Ä–µ–≤–æ–¥')
        return '–ü—Ä—è–º–æ–π –ø–µ—Ä–µ–≤–æ–¥ ‚Äî 300 —Ä—É–±. –Ω–∞ –∫–∞—Ä—Ç—É.\n–ü—Ä–∏—à–ª–∏—Ç–µ —Å–∫—Ä–∏–Ω –≤–∞—à–µ–º—É –ª–æ–≥–∏—Å—Ç—É ‚Äî –æ–Ω –≤—Å—ë –æ—Ä–≥–∞–Ω–∏–∑—É–µ—Ç.';
      if (prizeLabel === '–¥–∏—á—å –æ—Ç –ª–æ–≥–∏—Å—Ç–∞')
        return '–î–∏—á—å –æ—Ç –ª–æ–≥–∏—Å—Ç–∞ ‚Äî –ª–æ–≤–∏ –º–µ–º üòÑ';
      return prizeLabel;
    }

    /* ===== –í–ï–ë–•–£–ö ===== */
    function postPrize(payload){
      return fetch(WEBHOOK_URL, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        keepalive:true,
        body: JSON.stringify(payload)
      }).catch(()=>{});
    }

/* ===== –°–ü–ò–ù (–≤–µ—Å–∞) ===== */
function pickIndexByWeight(arr) {
  const total = arr.reduce((s, x) => s + (x.weight || 1), 0);
  let r = Math.random() * total;
  for (let i = 0; i < arr.length; i++) {
    r -= (arr[i].weight || 1);
    if (r <= 0) return i;
  }
  return arr.length - 1;
}

function spin(){
  if (spinning) return;
  if (!DEV_MODE && alreadyPlayed) return; // ¬´1 —Ä–∞–∑¬ª (–∫—Ä–æ–º–µ dev)

  spinning = true; 
  spinBtn.disabled = true;

  // –≤—ã–±–æ—Ä —Å–µ–∫—Ç–æ—Ä–∞ –ø–æ –≤–µ—Å–∞–º + —Ü–µ–ª–µ–≤–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞
  var chosenIdx = pickIndexByWeight(prizes);
  var stopAngle = chosenIdx * arc + arc/2;
  var total = (Math.random()*5 + 8)*2*Math.PI + stopAngle;
  var start = null, duration = 6000;

  function frame(ts){
    if(!start) start = ts;
    var p = Math.min(1, (ts - start)/duration);
    var ease = 1 - Math.pow(1 - p, 4);
    var angle = ease * total;

    ctx.clearRect(0, 0, canvas.width, canvas.height);
    drawWheel(angle);

    if (p < 1){
      requestAnimationFrame(frame);
    } else {
      var idx = chosenIdx;
      var prizeLabel = prizes[idx].label;

      var memeUrl = '';
      if (prizeLabel === '–¥–∏—á—å –æ—Ç –ª–æ–≥–∏—Å—Ç–∞' && LOGIST_MEMES.length){
        memeUrl = LOGIST_MEMES[Math.floor(Math.random()*LOGIST_MEMES.length)];
      }

      var messageHTML = buildMessageHTML(prizeLabel, memeUrl);
      var modalText   = textForModal(prizeLabel);

      // –º–æ–¥–∞–ª–∫–∞
      resultText.textContent = modalText;
      if (memeUrl){
        memeImg.src = memeUrl; 
        memeImg.classList.remove('hidden'); 
        memeImg.style.display = 'block';
      } else {
        memeImg.removeAttribute('src'); 
        memeImg.classList.add('hidden'); 
        memeImg.style.display = 'none';
      }
      modal.classList.remove('hidden');

      // –ª–æ–∫–∞–ª—å–Ω—ã–π ¬´1 —Ä–∞–∑¬ª
      try{ if(!DEV_MODE) localStorage.setItem(STORAGE_KEY, '1'); }catch(_){}
      alreadyPlayed = !DEV_MODE;

      // –æ—Ç–ø—Ä–∞–≤–∫–∞ –≤ n8n
      postPrize({
        tg_id: TG_ID,
        username: USERNAME,
        prize: prizeLabel,
        message_html: messageHTML,
        meme_url: memeUrl,
        ts: Date.now(),
        event_id: String(TG_ID||'0') + '-' + String(Date.now())
      });
    }
  }
  requestAnimationFrame(frame);
}

          // –º–æ–¥–∞–ª–∫–∞
          resultText.textContent = modalText;
          if (memeUrl){
            memeImg.src = memeUrl; memeImg.classList.remove('hidden'); memeImg.style.display='block';
          } else {
            memeImg.removeAttribute('src'); memeImg.classList.add('hidden'); memeImg.style.display='none';
          }
          modal.classList.remove('hidden');

          // –ª–æ–∫–∞–ª—å–Ω—ã–π ¬´1 —Ä–∞–∑¬ª
          try{ if(!DEV_MODE) localStorage.setItem(STORAGE_KEY,'1'); }catch(_){}
          alreadyPlayed = !DEV_MODE;

          // –æ—Ç–ø—Ä–∞–≤–∫–∞ –≤ n8n
          postPrize({
            tg_id: TG_ID,
            username: USERNAME,
            prize: prizeLabel,
            message_html: messageHTML,
            meme_url: memeUrl,
            ts: Date.now(),
            event_id: String(TG_ID||'0') + '-' + String(Date.now())
          });
        }
      }
      requestAnimationFrame(frame);
    }

    /* ===== INIT ===== */
    function init(){
      // DOM
      canvas     = document.getElementById('roulette');
      ctx        = canvas.getContext('2d');
      spinBtn    = document.getElementById('spin-btn');
      hint       = document.getElementById('hint');
      modal      = document.getElementById('result-modal');
      resultText = document.getElementById('result-text');
      memeImg    = document.getElementById('meme');
      closeModal = document.getElementById('close-modal');

      // reset –ø–æ –ø–∞—Ä–∞–º–µ—Ç—Ä—É
      try{ if (RESET_FLAG) localStorage.removeItem(STORAGE_KEY); }catch(_){}

      // ¬´1 —Ä–∞–∑¬ª (–∫—Ä–æ–º–µ dev)
      try{
        if (!DEV_MODE && localStorage.getItem(STORAGE_KEY)==='1'){
          alreadyPlayed = true; spinBtn.disabled = true;
          hint.textContent = '–í—ã —É–∂–µ –∫—Ä—É—Ç–∏–ª–∏ –∫–æ–ª–µ—Å–æ –Ω–∞ —ç—Ç–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ.';
        }
      }catch(_){}

      resizeCanvas();
      window.addEventListener('resize', resizeCanvas);
      spinBtn.addEventListener('click', spin);
      closeModal.addEventListener('click', function(){
        modal.classList.add('hidden');
        try{ tg && tg.close && tg.close(); }catch(_){}
      });
    }

    if (document.readyState === 'loading'){
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
  </script>
</body>
</html>




