<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–ö–æ–ª–µ—Å–æ –§–æ—Ä—Ç—É–Ω—ã</title>

  <style>
    :root{
      --bg1:#2c3e50; --bg2:#223043;
      --btn:#4c86ff; --btnText:#fff;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; color:#fff; font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Arial;
      display:flex; align-items:center; justify-content:center;
      background: radial-gradient(1000px 600px at 50% 0%, #34495e 0%, var(--bg1) 50%, var(--bg2) 100%);
    }
    .container{text-align:center; padding:16px}
    h1{margin:0 0 18px; font-weight:800; letter-spacing:.2px}

    .wheel-wrap{position:relative; width:350px; margin:0 auto}
    canvas{display:block; width:350px; height:350px; margin:0 auto; background:transparent}
    /* –û–î–ù–ê —Å—Ç—Ä–µ–ª–∫–∞ (HTML) */
    #pointer{
      position:absolute; top:50%; right:-6px; transform:translateY(-50%);
      width:0; height:0; border-top:12px solid transparent; border-bottom:12px solid transparent;
      border-left:26px solid #ff3b30; filter:drop-shadow(0 2px 2px rgba(0,0,0,.4));
    }

    #spin-btn{
      margin-top:22px; padding:14px 28px; font-size:16px; font-weight:700; cursor:pointer;
      border:none; border-radius:12px; background:var(--btn); color:var(--btnText);
      box-shadow:0 10px 24px rgba(76,134,255,.35), inset 0 0 0 1px rgba(255,255,255,.12);
      transition:transform .08s ease, filter .2s ease;
    }
    #spin-btn:hover{filter:brightness(1.06)}
    #spin-btn:active{transform:translateY(1px)}
    #spin-btn:disabled{background:#8a8a8a; cursor:not-allowed; box-shadow:none}

    .hint{opacity:.85; font-size:13px; margin:10px 0 0}

    /* –ú–æ–¥–∞–ª–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ */
    .modal{position:fixed; inset:0; background:rgba(0,0,0,.55);
      display:flex; align-items:center; justify-content:center; padding:16px;}
    .hidden{display:none}
    .modal-card{
      width:min(520px, 92vw); background:#1e2736; border-radius:16px; padding:22px 20px;
      box-shadow:0 12px 30px rgba(0,0,0,.45); text-align:left;
    }
    .modal-title{font-size:18px; font-weight:800; margin:0 0 10px; color:#fff}
    .modal-text{
      font-size:16px; line-height:1.6; color:#e9eef9;
      margin:0; white-space:pre-line; letter-spacing:.2px;
    }
    .modal-text b{color:#fff; font-weight:800}
    .modal-btn{
      margin-top:16px; padding:12px 18px; border:none; border-radius:10px;
      background:#36b37e; color:#fff; font-weight:700; cursor:pointer;
      box-shadow:0 6px 16px rgba(54,179,126,.35);
    }
    .meme{display:block; width:100%; max-height:360px; object-fit:contain; margin-top:14px; border-radius:10px}
  </style>
</head>
<body>
  <div class="container">
    <h1>–ò—Å–ø—ã—Ç–∞–π —Å–≤–æ—é —É–¥–∞—á—É!</h1>

    <div class="wheel-wrap">
      <canvas id="roulette" width="350" height="350"></canvas>
      <div id="pointer"></div> <!-- –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π —É–∫–∞–∑–∞—Ç–µ–ª—å -->
    </div>

    <button id="spin-btn">–ö—Ä—É—Ç–∏—Ç—å!</button>
    <p id="hint" class="hint"></p>
  </div>

  <!-- –ú–æ–¥–∞–ª–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ -->
  <div id="result-modal" class="modal hidden">
    <div class="modal-card">
      <div class="modal-title">–í–∞—à –ø—Ä–∏–∑</div>
      <div id="result-text" class="modal-text"></div>
      <img id="meme" class="meme hidden" alt="–º–µ–º"/>
      <button id="close-modal" class="modal-btn">–ü–æ–Ω—è—Ç–Ω–æ</button>
    </div>
  </div>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script>
    /* ===== –ù–ê–°–¢–†–û–ô–ö–ê ===== */
    // –ø—Ä–æ–¥-–≤–µ–±—Ö—É–∫ n8n (–±–µ–∑ "-test")
    var WEBHOOK_URL = 'https://solonflowai.ru/webhook/roulette_prize';

    // –º–µ–º—ã –¥–ª—è ¬´–¥–∏—á—å –æ—Ç –ª–æ–≥–∏—Å—Ç–∞¬ª (–ø–æ –∂–µ–ª–∞–Ω–∏—é)
    var LOGIST_MEMES = [
      // 'https://example.com/meme1.jpg',
      // 'https://example.com/meme2.png',
    ];

    /* ===== TELEGRAM SDK ===== */
    var tg = (window.Telegram && window.Telegram.WebApp) ? window.Telegram.WebApp : null;
    try { tg && tg.ready && tg.ready(); } catch (_) {}

    var user = (tg && tg.initDataUnsafe && tg.initDataUnsafe.user) ? tg.initDataUnsafe.user : null;

var TG_ID = user ? user.id : null;
    var USERNAME = user ? user.username : null;

    /* ===== DOM ===== */
    var canvas, ctx, spinBtn, hint, modal, resultText, memeImg, closeModal;

    /* ===== –î–ê–ù–ù–´–ï –°–ï–ö–¢–û–†–û–í (–¢–û–õ–¨–ö–û –ù–ê–ó–í–ê–ù–ò–Ø) ===== */
    var prizes = [
      { label: '—Å–æ–∫ –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç–∏', color: '#ff6b6b' },
      { label: '–±—ã—Å—Ç—Ä–∞—è –ø–æ–ª–∫–∞',     color: '#feca57' },
      { label: '–ø—Ä—è–º–æ–π –ø–µ—Ä–µ–≤–æ–¥',    color: '#48dbfb' },
      { label: '–¥–∏—á—å –æ—Ç –ª–æ–≥–∏—Å—Ç–∞',   color: '#1dd1a1' }
    ];

    /* ===== –°–û–°–¢–û–Ø–ù–ò–ï/–ì–ï–û–ú–ï–¢–†–ò–Ø ===== */
    var sectors = prizes.length;
    var arc = (2 * Math.PI) / sectors;
    var spinning = false;
    var alreadyPlayed = false;

    var DPR = Math.max(1, window.devicePixelRatio || 1);
    var VISUAL_SIZE = 350; // CSS-–ø–∏–∫—Å–µ–ª–∏

    /* ===== –£–¢–ò–õ–ò–¢–´ ===== */
    function showAlert(txt){ try { tg && tg.showAlert && tg.showAlert(txt); } catch(_) { alert(txt); } }

    function sendPrize(prizeText){
      var payload = {
        tg_id: TG_ID,
        username: USERNAME,
        prize: prizeText,
        ts: Date.now(),
        event_id: String(TG_ID || '0') + '-' + String(Date.now())
      };
      fetch(WEBHOOK_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        keepalive: true,
        body: JSON.stringify(payload)
      }).catch(function(e){ console.log('webhook error', e); });
    }

    function textAfterWin(prizeLabel){
      var map = {
        '—Å–æ–∫ –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç–∏':
          '–°–æ–∫ –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç–∏ ‚Äî 100 —Ä—É–±. –Ω–∞ –∫–∞—Ä—Ç—É.\n–ü—Ä–∏—à–ª–∏—Ç–µ —Å–∫—Ä–∏–Ω –≤–∞—à–µ–º—É –ª–æ–≥–∏—Å—Ç—É ‚Äî –æ–Ω –≤—Å—ë –æ—Ä–≥–∞–Ω–∏–∑—É–µ—Ç.',
        '–±—ã—Å—Ç—Ä–∞—è –ø–æ–ª–∫–∞':
          '–ë—ã—Å—Ç—Ä–∞—è –ø–æ–ª–∫–∞ ‚Äî –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –Ω–∞ —Å–ª–µ–¥—É—é—â—É—é –¥–æ—Å—Ç–∞–≤–∫—É.\n–ü—Ä–∏—à–ª–∏—Ç–µ —Å–∫—Ä–∏–Ω –≤–∞—à–µ–º—É –ª–æ–≥–∏—Å—Ç—É ‚Äî –æ–Ω –≤—Å—ë –æ—Ä–≥–∞–Ω–∏–∑—É–µ—Ç.',
        '–ø—Ä—è–º–æ–π –ø–µ—Ä–µ–≤–æ–¥':
          '–ü—Ä—è–º–æ–π –ø–µ—Ä–µ–≤–æ–¥ ‚Äî 300 —Ä—É–±. –Ω–∞ –∫–∞—Ä—Ç—É.\n–ü—Ä–∏—à–ª–∏—Ç–µ —Å–∫—Ä–∏–Ω –≤–∞—à–µ–º—É –ª–æ–≥–∏—Å—Ç—É ‚Äî –æ–Ω –≤—Å—ë –æ—Ä–≥–∞–Ω–∏–∑—É–µ—Ç.',
        '–¥–∏—á—å –æ—Ç –ª–æ–≥–∏—Å—Ç–∞':
          '–î–∏—á—å –æ—Ç –ª–æ–≥–∏—Å—Ç–∞ ‚Äî –ª–æ–≤–∏ –º–µ–º üòÑ\n(–ü—Ä–∏—à–ª–∏—Ç–µ —Å–∫—Ä–∏–Ω –≤–∞—à–µ–º—É –ª–æ–≥–∏—Å—Ç—É.)'
      };
      return map[prizeLabel] || prizeLabel;
    }

    /* ===== CANVAS ===== */
    function resizeCanvas(){
      var vw = Math.min(380, Math.floor(window.innerWidth * 0.9));
      VISUAL_SIZE = Math.max(260, vw);

      // CSS —Ä–∞–∑–º–µ—Ä
      canvas.style.width  = VISUAL_SIZE + 'px';
      canvas.style.height = VISUAL_SIZE + 'px';

      // —Ä–µ–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä (–¥–ª—è —Ä–µ—Ç–∏–Ω—ã)
      canvas.width  = Math.floor(VISUAL_SIZE * DPR);
      canvas.height = Math.floor(VISUAL_SIZE * DPR);

      ctx.setTransform(1,0,0,1,0,0);
      ctx.scale(DPR, DPR);
      ctx.imageSmoothingEnabled = true;

      drawStatic();
    }

    function drawWheel(angle){
      var W = VISUAL_SIZE, H = VISUAL_SIZE;
      var cx = W/2, cy = H/2, r = Math.min(cx, cy) - 8;

      ctx.save();
      ctx.translate(cx, cy);
      ctx.rotate(angle || 0);
      ctx.translate(-cx, -cy);

      for (var i=0; i<sectors; i++){
        var a0 = i*arc, a1 = a0 + arc;

        // —Å–µ–∫—Ç–æ—Ä
        ctx.beginPath();
        ctx.moveTo(cx, cy);
        ctx.fillStyle = prizes[i].color;
        ctx.arc(cx, cy, r, a0, a1);
        ctx.closePath();
        ctx.fill();

        // —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–∏
        ctx.strokeStyle = 'rgba(0,0,0,.15)';
        ctx.lineWidth = 1;
        ctx.beginPath();
        ctx.arc(cx, cy, r, a0, a1);
        ctx.stroke();

        // –¢–û–õ–¨–ö–û –ù–ê–ó–í–ê–ù–ò–ï
        ctx.save();
        ctx.translate(cx, cy);
        ctx.rotate(a0 + arc/2);
        ctx.fillStyle = '#fff';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.font = '600 16px -apple-system, Segoe UI, Roboto, Arial';
        ctx.shadowColor = 'rgba(0,0,0,.35)';
        ctx.shadowBlur = 1.5;
        ctx.fillText(prizes[i].label, r * 0.58, 0);
        ctx.restore();
      }
      ctx.restore();

      // –±–µ–ª—ã–π –æ–±–æ–¥–æ–∫
      ctx.lineWidth = 6;
      ctx.strokeStyle = 'rgba(255,255,255,.9)';
      ctx.beginPath(); ctx.arc(cx, cy, r+2, 0, Math.PI*2); ctx.stroke();

      // —Ü–µ–Ω—Ç—Ä
      ctx.fillStyle = '#e5ecff';
      ctx.beginPath(); ctx.arc(cx, cy, 14, 0, Math.PI*2); ctx.fill();
      ctx.strokeStyle = 'rgba(0,0,0,.12)';
      ctx.lineWidth = 1; ctx.stroke();
    }

function drawStatic(){
      ctx.clearRect(0,0,canvas.width,canvas.height);
      drawWheel(0);
    }

    /* ===== –†–ï–ó–£–õ–¨–¢–ê–¢ ===== */
    function openResult(prizeLabel){
      var text = textAfterWin(prizeLabel);
      resultText.textContent = text;

      if (prizeLabel === '–¥–∏—á—å –æ—Ç –ª–æ–≥–∏—Å—Ç–∞' && LOGIST_MEMES.length){
        var idx = Math.floor(Math.random()*LOGIST_MEMES.length);
        memeImg.src = LOGIST_MEMES[idx];
        memeImg.classList.remove('hidden');
        memeImg.style.display = 'block';
      } else {
        memeImg.removeAttribute('src');
        memeImg.classList.add('hidden');
        memeImg.style.display = 'none';
      }

      modal.classList.remove('hidden');
    }

    /* ===== –°–ü–ò–ù ===== */
    function spin(){
      if (spinning || alreadyPlayed) return;
      spinning = true;
      spinBtn.disabled = true;

      var total = (Math.random()*5 + 8) * 2*Math.PI + Math.random()*2*Math.PI;
      var start = null;
      var duration = 6000;

      function tick(t){
        if (!start) start = t;
        var p = Math.min(1, (t - start)/duration);
        var ease = 1 - Math.pow(1-p, 4);
        var angle = ease * total;

        ctx.clearRect(0,0,canvas.width,canvas.height);
        drawWheel(angle);

        if (p < 1){
          requestAnimationFrame(tick);
        } else {
          var current = angle % (2*Math.PI);
          var winningAngle = (2*Math.PI - current) % (2*Math.PI);
          var idx = Math.floor(winningAngle/arc) % sectors;
          var prizeLabel = prizes[idx].label;

          // –ª–æ–∫–∞–ª—å–Ω–∞—è –∑–∞—â–∏—Ç–∞ ¬´1 —Ä–∞–∑¬ª
          try { localStorage.setItem('roulette_played', '1'); } catch(_) {}
          alreadyPlayed = true;

          // –≤ n8n
          sendPrize(prizeLabel);

          // –ø–æ–∫–∞–∑–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç
          openResult(prizeLabel);
        }
      }
      requestAnimationFrame(tick);
    }

    /* ===== INIT ===== */
    document.addEventListener('DOMContentLoaded', function(){
      canvas = document.getElementById('roulette');
      ctx    = canvas.getContext('2d');
      spinBtn= document.getElementById('spin-btn');
      hint   = document.getElementById('hint');
      modal  = document.getElementById('result-modal');
      resultText = document.getElementById('result-text');
      memeImg    = document.getElementById('meme');
      closeModal = document.getElementById('close-modal');

      // —Ä–µ–∂–∏–º —Ç–µ—Å—Ç–∞: ?dev=1 ‚Äî –æ—Ç–∫–ª—é—á–∞–µ—Ç –ª–æ–∫-1-—Ä–∞–∑ –Ω–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ
      var params = new URLSearchParams(location.search);
      var DEV = params.get('dev') === '1';

      try {
        if (!DEV && localStorage.getItem('roulette_played') === '1'){
          alreadyPlayed = true;
          spinBtn.disabled = true;
          hint.textContent = '–í—ã —É–∂–µ –∫—Ä—É—Ç–∏–ª–∏ –∫–æ–ª–µ—Å–æ –Ω–∞ —ç—Ç–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ.';
        }
      } catch(_) {}

      resizeCanvas();
      window.addEventListener('resize', resizeCanvas);

      spinBtn.addEventListener('click', spin);
      closeModal.addEventListener('click', function(){
        modal.classList.add('hidden');
        try { tg && tg.close && tg.close(); } catch(_){}
      });
    });
  </script>
</body>
</html>
